<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D2 Management System - Premium Official</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.02);
            --border: rgba(255, 255, 255, 0.08);
            --gold: #fbbf24;
            --gold-dark: #b45309;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: #05070a;
            color: #f1f5f9;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }
        /* Estilo Apple Glassmorphism */
        .glass { 
            background: var(--glass); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px); 
            border: 1px solid var(--border); 
            border-radius: 28px; 
            box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.8);
        }
        .glass-input { 
            background: rgba(0, 0, 0, 0.4) !important; 
            border: 1px solid var(--border) !important; 
            border-radius: 14px !important; 
            color: white !important; 
            padding: 14px 18px !important; 
            width: 100%; 
            outline: none; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .glass-input:focus { 
            border-color: var(--gold) !important;
            background: rgba(0, 0, 0, 0.6) !important;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.15) !important;
        }
        .btn-gold {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: black;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(180, 83, 9, 0.2);
        }
        .btn-gold:hover { transform: translateY(-2px); filter: brightness(1.1); box-shadow: 0 8px 30px rgba(180, 83, 9, 0.4); }
        .btn-gold:active { transform: translateY(0); }

        .tab-btn { 
            padding-bottom: 14px; 
            border-bottom: 3px solid transparent; 
            color: #475569; 
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s; 
            cursor: pointer; 
        }
        .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }
        
        .logo-header { max-height: 55px; width: auto; transition: all 0.5s ease; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .logo-login { max-width: 340px; height: auto; margin-bottom: 2.5rem; filter: drop-shadow(0 0 15px rgba(251, 191, 36, 0.1)); }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .glass { border: 1px solid #ddd !important; background: transparent !important; box-shadow: none !important; border-radius: 0 !important; }
            #report-output { display: block !important; padding: 0 !important; }
        }
        
        .flag-btn { font-size: 1.6rem; opacity: 0.3; transition: all 0.2s; cursor: pointer; border: none; background: none; }
        .flag-btn:hover, .flag-btn.active { opacity: 1; transform: scale(1.2); }
        .log-row:nth-child(even) { background: rgba(255,255,255,0.01); }
        
        /* Ocultar barra de scroll sem perder fun√ß√£o */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

<!-- Authentication Overlay -->
<div id="auth-container" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#030508] p-6">
    <div class="glass p-12 w-full max-w-md text-center">
        <!-- Logo Principal D2 Group -->
        <img src="logo-D2-Group-preto.png" alt="D2 Group" class="logo-login mx-auto" onerror="this.src='https://placehold.co/400x150/05070a/fbbf24?text=D2+GROUP'">
        
        <p id="auth-subtitle" class="text-slate-500 text-[10px] mb-12 font-black tracking-[0.3em] uppercase" data-i18n="login_subtitle">Sistema Integrado de Gest√£o</p>
        
        <form id="login-form" onsubmit="handleAuth(event)" class="space-y-6 text-left">
            <div>
                <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest block mb-2 ml-1">Utilizador Corporativo</label>
                <input type="email" id="auth-email" required class="glass-input" placeholder="dante.frota@allcablingtech.com">
            </div>
            <div class="relative">
                <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest block mb-2 ml-1" data-i18n="field_password">Chave de Acesso</label>
                <input type="password" id="auth-password" required class="glass-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <button type="button" onclick="togglePasswordVisibility('auth-password')" class="absolute right-4 top-10 text-slate-500 hover:text-white transition-colors">
                    üëÅÔ∏è
                </button>
            </div>
            <button type="submit" class="w-full btn-gold p-5 rounded-2xl flex items-center justify-center mt-8 text-sm font-black" data-i18n="btn_login">
                Autenticar e Entrar
            </button>
            <button type="button" onclick="resetPassword()" class="w-full text-[10px] text-slate-600 hover:text-amber-500 mt-6 transition-colors uppercase font-black tracking-widest text-center" data-i18n="forgot_password">Recuperar Acesso</button>
        </form>
    </div>
</div>

<!-- Main Application Interface -->
<div id="app-container" class="hidden min-h-screen flex flex-col">
    <header class="no-print sticky top-0 z-40 bg-[#05070a]/90 backdrop-blur-3xl border-b border-white/5 p-5">
        <div class="max-w-7xl mx-auto flex flex-wrap justify-between items-center gap-6">
            <div class="flex items-center gap-10">
                <!-- Logotipo Din√¢mico conforme a divis√£o -->
                <img id="header-logo" src="logo-D2-SmartHome-preto.png" alt="D2 Logo" class="logo-header" onerror="this.src='https://placehold.co/220x60/05070a/fbbf24?text=D2+MANAGEMENT'">
                <div class="flex gap-4">
                    <button onclick="setLanguage('pt')" id="lang-pt" class="flag-btn active" title="Portugu√™s">üáßüá∑</button>
                    <button onclick="setLanguage('en')" id="lang-en" class="flag-btn" title="English">üá∫üá∏</button>
                    <button onclick="setLanguage('es')" id="lang-es" class="flag-btn" title="Espa√±ol">üá™üá∏</button>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <div class="flex bg-black/40 p-1.5 rounded-2xl border border-white/5 text-[10px] font-black uppercase tracking-[0.15em]">
                    <button onclick="switchCompany('Smart Home')" id="btn-smart" class="px-6 py-3 rounded-xl transition-all bg-amber-600 text-black">Smart Home</button>
                    <button onclick="switchCompany('HVAC')" id="btn-hvac" class="px-6 py-3 rounded-xl transition-all text-slate-500 hover:text-white">HVAC Solutions</button>
                </div>
                <div class="flex items-center gap-5 border-l border-white/10 pl-6">
                    <div class="text-right hidden sm:block">
                        <p id="user-display" class="text-[10px] font-black text-slate-300"></p>
                        <p class="text-[8px] text-amber-500 font-bold uppercase tracking-widest">Sess√£o Segura</p>
                    </div>
                    <button onclick="logout()" class="text-red-400 hover:text-white hover:bg-red-500/20 p-3 glass rounded-2xl transition-all" title="Sair">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto w-full p-6 md:p-10 flex-1">
        <!-- Tabs Navigation -->
        <div class="no-print flex gap-10 mb-12 border-b border-white/5 overflow-x-auto scrollbar-hide">
            <button onclick="showSection('projects')" id="tab-projects" class="tab-btn active" data-i18n="nav_projects">Projetos</button>
            <button onclick="showSection('new')" id="tab-new" class="tab-btn" data-i18n="nav_new">Novo Registo</button>
            <button onclick="showSection('reports')" id="tab-reports" class="tab-btn" data-i18n="nav_reports">Relat√≥rios</button>
            <button onclick="showSection('logs')" id="tab-logs" class="tab-btn hidden admin-only" data-i18n="nav_logs">Auditoria</button>
            <button onclick="showSection('users')" id="tab-users" class="tab-btn hidden admin-only" data-i18n="nav_users">Equipa</button>
        </div>

        <!-- Section: Projects -->
        <section id="section-projects" class="space-y-8">
            <h3 class="text-3xl font-black tracking-tighter mb-10 uppercase" data-i18n="active_projects">Portfolio de Obras</h3>
            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10"></div>
        </section>

        <!-- Section: Form -->
        <section id="section-new" class="hidden max-w-4xl mx-auto">
            <div class="glass p-12">
                <h3 class="text-2xl font-black mb-10 text-amber-500 uppercase tracking-tighter border-l-4 border-amber-500 pl-4" id="form-title" data-i18n="form_new">Novo Registo de Obra</h3>
                <form id="main-form" onsubmit="handleFormSubmit(event)" class="space-y-8">
                    <input type="hidden" id="edit-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-[0.2em] block mb-3 ml-1" data-i18n="field_client">Cliente</label>
                            <input type="text" name="cliente" required class="glass-input">
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-[0.2em] block mb-3 ml-1" data-i18n="field_vendedor">Vendedor</label>
                            <input type="text" name="vendedor" required class="glass-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-[0.2em] block mb-3 ml-1" data-i18n="field_value">Valor Total ($)</label>
                            <input type="number" step="0.01" name="valorTotal" required class="glass-input">
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-[0.2em] block mb-3 ml-1" data-i18n="field_method">M√©todo Pagamento</label>
                            <select name="metodo" class="glass-input">
                                <option value="Zelle">Zelle</option>
                                <option value="CC">Cart√£o Cr√©dito (-3%)</option>
                                <option value="Cash">Cash</option>
                                <option value="Wire">Wire Transfer</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-[0.2em] block mb-3 ml-1" data-i18n="field_commission">% Comis.</label>
                            <input type="number" name="percComissao" value="10" class="glass-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-[0.2em] block mb-3 ml-1" data-i18n="field_start">Data In√≠cio</label>
                            <input type="date" name="dataInicio" required class="glass-input">
                        </div>
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-black tracking-[0.2em] block mb-3 ml-1" data-i18n="field_end">Previs√£o Entrega</label>
                            <input type="date" name="dataEntrega" required class="glass-input">
                        </div>
                    </div>
                    <div>
                        <label class="text-[9px] text-slate-500 uppercase font-black tracking-[0.2em] block mb-3 ml-1" data-i18n="field_status">Estado Atual</label>
                        <select name="status" class="glass-input">
                            <option value="Cota√ß√£o">Cota√ß√£o</option>
                            <option value="Aguardando In√≠cio">Aguardando In√≠cio</option>
                            <option value="Em Execu√ß√£o">Em Execu√ß√£o</option>
                            <option value="Finalizado">Finalizado</option>
                        </select>
                    </div>
                    <div class="flex gap-8 pt-10">
                        <button type="submit" class="flex-1 btn-gold p-5 rounded-2xl font-black text-sm" data-i18n="btn_save">Validar e Salvar</button>
                        <button type="button" onclick="showSection('projects')" class="px-12 py-5 text-slate-600 font-black hover:text-white transition-colors text-[10px] tracking-widest" data-i18n="btn_cancel">DESCARTAR</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Section: Reports -->
        <section id="section-reports" class="hidden">
            <div class="no-print glass p-10 mb-12">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8 items-end">
                    <div>
                        <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest block mb-3 ml-1" data-i18n="field_company">Divis√£o</label>
                        <select id="report-filter-company" class="glass-input">
                            <option value="All" data-i18n="all">D2 Group (Geral)</option>
                            <option value="Smart Home">D2 Smart Home</option>
                            <option value="HVAC">D2 HVAC Solutions</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] text-slate-500 uppercase font-black tracking-widest block mb-3 ml-1" data-i18n="field_status">Status</label>
                        <select id="report-filter-status" class="glass-input">
                            <option value="All" data-i18n="all">Todos os Estados</option>
                            <option value="Em Execu√ß√£o">Em Execu√ß√£o</option>
                            <option value="Finalizado">Finalizado</option>
                        </select>
                    </div>
                    <button onclick="generateReport()" class="btn-gold p-3.5 rounded-xl text-xs font-black" data-i18n="btn_apply">Gerar Relat√≥rio</button>
                    <button onclick="window.print()" class="bg-slate-900 hover:bg-slate-800 p-3.5 rounded-xl text-white text-xs font-black border border-white/5" data-i18n="btn_print">PRINT / PDF</button>
                </div>
            </div>
            <div id="report-output"></div>
        </section>

        <!-- Section: Logs -->
        <section id="section-logs" class="hidden">
            <div class="glass overflow-hidden border border-white/5">
                <table class="w-full text-left text-sm">
                    <thead class="bg-white/[0.03] text-slate-500 uppercase text-[9px] font-black tracking-[0.25em]">
                        <tr>
                            <th class="p-6">Data/Hora</th>
                            <th class="p-6">Agente</th>
                            <th class="p-6">Opera√ß√£o</th>
                            <th class="p-6">Descri√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="logs-body"></tbody>
                </table>
            </div>
        </section>

        <!-- Section: Users -->
        <section id="section-users" class="hidden">
            <div id="users-list" class="grid grid-cols-1 lg:grid-cols-2 gap-10"></div>
        </section>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CREDENCIAIS REAIS EXTRA√çDAS DA IMAGE_2DFB64.PNG ---
    const firebaseConfig = {
        apiKey: "AIzaSyDrLFiOuBwZblwKPuxBRK3R4fQpjQQbnDE",
        authDomain: "d2-project-management.firebaseapp.com",
        projectId: "d2-project-management",
        storageBucket: "d2-project-management.firebasestorage.app",
        messagingSenderId: "254630664761",
        appId: "1:254630664761:web:0d3c9c840bde488353cbe8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const appId = 'd2-Project-Management'; 
    const SUPER_ADMIN = "dante.frota@allcablingtech.com";

    let state = { currentUser: null, projects: [], lang: 'pt', company: 'Smart Home' };

    const translations = {
        pt: { 
            login_subtitle: "Sistema Integrado de Gest√£o", field_password: "Chave de Acesso", btn_login: "Autenticar e Entrar", forgot_password: "Recuperar Acesso",
            nav_projects: "Projetos", nav_new: "Novo Registo", nav_reports: "Relat√≥rios", nav_logs: "Auditoria", nav_users: "Equipa",
            active_projects: "Portfolio de Obras", field_client: "Cliente", field_vendedor: "Vendedor", field_value: "Valor Total",
            field_method: "Pagamento", field_commission: "% Comis.", field_start: "In√≠cio", field_end: "Entrega", field_status: "Estado",
            btn_save: "Validar e Salvar", btn_cancel: "DESCARTAR", btn_print: "PRINT / PDF", all: "D2 Group (Geral)",
            executing: "Em Execu√ß√£o", finished: "Finalizado", form_new: "Novo Registo de Obra", form_edit: "Atualizar Registo"
        },
        en: {
            login_subtitle: "Integrated Management System", field_password: "Access Password", btn_login: "Authenticate & Sign In", forgot_password: "Reset Password",
            nav_projects: "Projects", nav_new: "New Entry", nav_reports: "Reports", nav_logs: "Audit", nav_users: "Team",
            active_projects: "Project Portfolio", field_client: "Client", field_vendedor: "Sales Rep", field_value: "Total Value",
            field_method: "Method", field_commission: "% Comm.", field_start: "Start", field_end: "Delivery", field_status: "Status",
            btn_save: "Validate & Save", btn_cancel: "DISCARD", btn_print: "PRINT / PDF", all: "D2 Group (Global)",
            executing: "Executing", finished: "Finished", form_new: "New Project Registry", form_edit: "Update Registry"
        },
        es: {
            login_subtitle: "Sistema Integrado de Gesti√≥n", field_password: "Clave de Acceso", btn_login: "Autenticar y Entrar", forgot_password: "Recuperar Clave",
            nav_projects: "Proyectos", nav_new: "Nuevo Registro", nav_reports: "Informes", nav_logs: "Auditor√≠a", nav_users: "Equipo",
            active_projects: "Cartera de Obras", field_client: "Cliente", field_vendedor: "Vendedor", field_value: "Valor Total",
            field_method: "Modalidad", field_commission: "% Comisi√≥n", field_start: "Apertura", field_end: "Entrega", field_status: "Estado",
            btn_save: "Validar y Guardar", btn_cancel: "DESCARTAR", btn_print: "PRINT / PDF", all: "D2 Group (General)",
            executing: "En Ejecuci√≥n", finished: "Finalizado", form_new: "Nuevo Registro de Obra", form_edit: "Actualizar Registro"
        }
    };

    async function addLog(action, details) {
        if (!state.currentUser) return;
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                timestamp: serverTimestamp(),
                user: state.currentUser.email,
                action: action,
                details: details
            });
        } catch (e) { console.error("Log error", e); }
    }

    window.handleAuth = async (e) => {
        e.preventDefault();
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value.trim();
        try {
            const cred = await signInWithEmailAndPassword(auth, email, password);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_credentials', cred.user.uid), {
                email, password, lastLogin: serverTimestamp()
            }, { merge: true });
        } catch (err) { 
            // Tratamento amig√°vel de erro de chave ou credencial
            const msg = err.code === 'auth/api-key-not-valid' ? 'Erro de Sincroniza√ß√£o. Verifique as chaves do Firebase.' : err.message;
            alert("Acesso Negado: " + msg); 
        }
    };

    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        state.currentUser = user;
        document.getElementById('auth-container').classList.toggle('hidden', !!user);
        document.getElementById('app-container').classList.toggle('hidden', !user);
        
        if (user) {
            document.getElementById('user-display').innerText = user.email.split('@')[0].toUpperCase();
            if (user.email === SUPER_ADMIN) {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            }

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), snap => {
                state.projects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderProjects();
                if (user.email === SUPER_ADMIN) renderUserManagement();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), snap => {
                renderLogs(snap.docs.map(d => d.data()));
            });
        }
    });

    window.handleFormSubmit = async (e) => {
        e.preventDefault();
        const f = new FormData(e.target);
        const editId = document.getElementById('edit-id').value;
        const data = {
            empresa: state.company,
            cliente: f.get('cliente'),
            vendedor: f.get('vendedor'),
            valorTotal: parseFloat(f.get('valorTotal')),
            metodo: f.get('metodo'),
            percComissao: parseInt(f.get('percComissao')),
            dataInicio: f.get('dataInicio'),
            dataEntrega: f.get('dataEntrega'),
            status: f.get('status'),
            updatedAt: serverTimestamp()
        };

        try {
            if (editId) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', editId), data);
                await addLog('UPDATE', `Obra: ${data.cliente}`);
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), {
                    ...data, createdAt: serverTimestamp()
                });
                await addLog('INSERT', `Obra: ${data.cliente}`);
            }
            e.target.reset();
            showSection('projects');
        } catch (err) { alert(err.message); }
    };

    window.deleteProject = async (id, name) => {
        if (!confirm(`Remover permanentemente a obra de ${name}?`)) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', id));
            await addLog('DELETE', `Obra: ${name}`);
        } catch (err) { alert(err.message); }
    };

    window.editProject = (id) => {
        const p = state.projects.find(x => x.id === id);
        if (!p) return;
        document.getElementById('edit-id').value = id;
        document.getElementById('form-title').setAttribute('data-i18n', 'form_edit');
        setLanguage(state.lang);
        const f = document.getElementById('main-form');
        f.cliente.value = p.cliente;
        f.vendedor.value = p.vendedor;
        f.valorTotal.value = p.valorTotal;
        f.metodo.value = p.metodo;
        f.percComissao.value = p.percComissao;
        f.dataInicio.value = p.dataInicio;
        f.dataEntrega.value = p.dataEntrega;
        f.status.value = p.status;
        showSection('new');
    };

    function renderProjects() {
        const grid = document.getElementById('projects-grid');
        grid.innerHTML = '';
        state.projects.filter(p => p.empresa === state.company).forEach(p => {
            let base = p.valorTotal * (p.metodo === 'CC' ? 0.97 : 1);
            const comm = (base * (p.percComissao / 100)).toFixed(2);
            const card = document.createElement('div');
            card.className = 'glass p-8 space-y-8 transition-all hover:scale-[1.03] border-l-8 ' + (p.status === 'Finalizado' ? 'border-emerald-500' : 'border-amber-500');
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-black text-xl text-white tracking-tighter">${p.cliente}</h4>
                        <p class="text-[9px] text-slate-500 uppercase font-black tracking-[0.2em] mt-2">${p.vendedor} ‚Ä¢ ${p.metodo}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editProject('${p.id}')" class="p-2 hover:bg-white/10 rounded-xl text-slate-400 hover:text-white transition-all">‚úèÔ∏è</button>
                        <button onclick="deleteProject('${p.id}', '${p.cliente}')" class="p-2 hover:bg-red-500/10 rounded-xl text-slate-400 hover:text-red-400 transition-all">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-6 bg-black/40 p-6 rounded-[24px] border border-white/5">
                    <div>
                        <p class="text-[8px] text-slate-600 font-black uppercase mb-1 tracking-widest">Contrato</p>
                        <p class="font-extrabold text-white text-lg">$ ${p.valorTotal.toLocaleString()}</p>
                    </div>
                    <div>
                        <p class="text-[8px] text-amber-500 font-black uppercase mb-1 tracking-widest">Comiss√£o</p>
                        <p class="text-amber-500 font-extrabold text-lg">$ ${comm}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest">
                    <span class="px-4 py-2 rounded-xl bg-white/[0.05] text-slate-400 border border-white/5">${p.status}</span>
                    <span class="text-slate-600">${new Date(p.dataEntrega).toLocaleDateString()}</span>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    async function renderUserManagement() {
        const container = document.getElementById('users-list');
        container.innerHTML = '';
        const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'user_credentials'));
        snap.forEach(d => {
            const u = d.data();
            const el = document.createElement('div');
            el.className = 'glass p-8 flex justify-between items-center border-l-8 border-amber-600';
            el.innerHTML = `
                <div>
                    <p class="font-black text-white text-lg mb-1 tracking-tight">${u.email}</p>
                    <div class="flex items-center gap-4 mt-3">
                        <span class="text-[9px] text-slate-600 font-black uppercase tracking-widest">Chave:</span>
                        <input type="password" value="${u.password}" id="p-view-${d.id}" readonly class="bg-transparent border-none text-slate-400 text-sm focus:outline-none font-bold">
                        <button onclick="togglePasswordVisibility('p-view-${d.id}')" class="text-xs text-slate-500 hover:text-white">üëÅÔ∏è</button>
                    </div>
                </div>
            `;
            container.appendChild(el);
        });
    }

    function renderLogs(logs) {
        const body = document.getElementById('logs-body');
        body.innerHTML = '';
        const sorted = [...logs].sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        sorted.slice(0, 40).forEach(l => {
            body.innerHTML += `
                <tr class="log-row border-b border-white/5 hover:bg-white/[0.01] transition-colors">
                    <td class="p-6 text-[10px] text-slate-600 font-bold">${l.timestamp?.toDate().toLocaleString() || '---'}</td>
                    <td class="p-6 text-[11px] font-black text-slate-300">${l.user}</td>
                    <td class="p-6 text-[9px] font-black text-amber-600 uppercase tracking-widest">${l.action}</td>
                    <td class="p-6 text-[11px] text-slate-500">${l.details}</td>
                </tr>
            `;
        });
    }

    window.generateReport = () => {
        const out = document.getElementById('report-output');
        const cF = document.getElementById('report-filter-company').value;
        const sF = document.getElementById('report-filter-status').value;
        const filtered = state.projects.filter(p => (cF === 'All' || p.empresa === cF) && (sF === 'All' || p.status === sF));
        
        const logoUrl = cF === 'HVAC' ? 'logo-D2-HVAC-Solutions-preto.png' : 
                      (cF === 'Smart Home' ? 'logo-D2-SmartHome-preto.png' : 'logo-D2-Group-preto.png');

        let totalV = 0, totalC = 0;
        const rows = filtered.map(p => {
            let com = p.valorTotal * (p.metodo === 'CC' ? 0.97 : 1) * (p.percComissao / 100);
            totalV += p.valorTotal; totalC += com;
            return `<tr class="border-b border-gray-100"><td class="py-5 font-black">${p.cliente}</td><td>${p.vendedor}</td><td class="text-right font-medium">$ ${p.valorTotal.toFixed(2)}</td><td class="text-right font-black text-amber-600">$ ${com.toFixed(2)}</td></tr>`;
        }).join('');
        
        out.innerHTML = `
            <div class="p-16 bg-white text-slate-900 rounded-[40px] shadow-2xl report-card">
                <div class="flex justify-between items-center border-b-8 border-slate-950 pb-12 mb-12">
                    <img src="${logoUrl}" alt="D2 Logo" style="max-height: 90px;">
                    <div class="text-right">
                        <h2 class="text-3xl font-black uppercase tracking-tighter text-slate-950">Relat√≥rio Executivo</h2>
                        <p class="text-slate-400 text-[11px] font-black uppercase tracking-widest mt-2">${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
                <table class="w-full text-sm mb-16">
                    <thead><tr class="text-left bg-slate-100 text-slate-500 text-[11px] font-black uppercase tracking-widest"><th class="p-5">Entidade</th><th class="p-5">Respons√°vel</th><th class="p-5 text-right">Volume Contrato</th><th class="p-5 text-right">Comiss√£o Liq.</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="flex justify-end gap-20 pt-12 border-t-8 border-slate-950">
                    <div class="text-right">
                        <p class="text-[11px] text-slate-400 uppercase font-black tracking-widest mb-3">Faturamento Global</p>
                        <p class="text-5xl font-black text-slate-950 tracking-tighter">$ ${totalV.toLocaleString(undefined, {minimumFractionDigits: 2})}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[11px] text-amber-600 uppercase font-black tracking-widest mb-3">Total Comiss√µes</p>
                        <p class="text-5xl font-black text-amber-600 tracking-tighter">$ ${totalC.toLocaleString(undefined, {minimumFractionDigits: 2})}</p>
                    </div>
                </div>
            </div>`;
    };

    window.setLanguage = (lang) => {
        state.lang = lang;
        document.querySelectorAll('.flag-btn').forEach(b => b.classList.toggle('active', b.id === 'lang-'+lang));
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang][key]) el.innerText = translations[lang][key];
        });
    };

    window.switchCompany = (c) => {
        state.company = c;
        const logoEl = document.getElementById('header-logo');
        const btnS = document.getElementById('btn-smart');
        const btnH = document.getElementById('btn-hvac');
        
        if(c === 'Smart Home') {
            logoEl.src = 'logo-D2-SmartHome-preto.png';
            btnS.classList.add('bg-amber-600', 'text-black');
            btnH.classList.remove('bg-amber-600', 'text-black');
        } else {
            logoEl.src = 'logo-D2-HVAC-Solutions-preto.png';
            btnH.classList.add('bg-amber-600', 'text-black');
            btnS.classList.remove('bg-amber-600', 'text-black');
        }
        renderProjects();
    };

    window.showSection = (id) => {
        document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
        document.getElementById(`section-${id}`).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-'+id));
    };

    window.togglePasswordVisibility = (id) => {
        const el = document.getElementById(id);
        if(el) el.type = el.type === 'password' ? 'text' : 'password';
    };

    setLanguage('pt');
</script>
</body>
</html>