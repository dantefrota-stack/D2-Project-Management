<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D2 Project Management - Premium Official</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --gold: #fbbf24; --gold-dark: #b45309; --d2-blue: #0f172a; }
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s; margin: 0; }

        /* Design Login - Enterprise Portal Pattern */
        .auth-body { background-color: #f1f5f9; color: #0f172a; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .auth-card {
            background: white; border-radius: 40px; width: 100%; max-width: 440px;
            padding: 48px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1); text-align: center;
        }
        .logo-box { background: var(--d2-blue); border-radius: 20px; padding: 20px; display: inline-block; margin-bottom: 24px; }
        .label-auth { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; display: block; text-align: left; }
        .auth-input {
            width: 100%; padding: 16px 20px; border-radius: 12px; background: #f8fafc;
            border: 1px solid #e2e8f0; color: #0f172a; outline: none; transition: all 0.2s; font-size: 15px;
        }
        .auth-input:focus { border-color: var(--gold); box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.1); }
        .btn-access {
            width: 100%; background: var(--d2-blue); color: white; padding: 18px;
            border-radius: 14px; font-weight: 800; text-transform: uppercase;
            letter-spacing: 0.1em; transition: all 0.3s; margin-top: 10px; border: none; cursor: pointer;
        }
        .btn-access:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(15, 23, 42, 0.2); }

        /* Interface Interna */
        .app-body-dark { background-color: #030508; color: #f1f5f9; }
        .modern-input {
            width: 100%; padding: 14px 45px 14px 16px; border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2); background: rgba(0,0,0,0.5);
            color: inherit; outline: none; transition: all 0.2s; font-size: 14px;
        }
        .light .modern-input { background: #fff; border: 1px solid #cbd5e1; color: #000; }

        /* FIX DO OLHO - SVG Puro embutido */
        .password-toggle {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            z-index: 100; color: var(--gold); cursor: pointer;
            background: rgba(0,0,0,0.2); border-radius: 8px; padding: 6px;
            display: flex; align-items: center; justify-content: center; border: none;
        }
        .password-toggle svg { width: 18px; height: 18px; stroke-width: 2.5; }

        /* Unidades - Pill Filtros */
        .unit-pill { padding: 8px 20px; border-radius: 20px; font-size: 10px; font-weight: 800; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; color: #64748b; background: transparent; }
        .unit-pill.active { background: var(--gold); color: #000; border-color: var(--gold); }

        /* Bot√£o Premium Gold */
        .btn-premium-gold {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            color: #000; font-weight: 900; padding: 16px; border-radius: 14px;
            text-transform: uppercase; letter-spacing: 0.1em; border: none;
            width: 100%; cursor: pointer; transition: all 0.3s; text-align: center;
        }
        .btn-premium-gold:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4); }

        /* Calend√°rio Premium */
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent; bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto; z-index: 20;
        }
        .date-container { position: relative; display: flex; align-items: center; width: 100%; }
        .calendar-icon-overlay { position: absolute; right: 14px; pointer-events: none; color: var(--gold); z-index: 10; }

        /* Painel Financeiro Expans√≠vel */
        .finance-panel { max-height: 0; overflow: hidden; transition: all 0.5s ease; opacity: 0; }
        .finance-panel.open { max-height: 1500px; opacity: 1; margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem; }

        /* Barra de Progresso Degrad√™ Din√¢mico */
        .progress-track { height: 16px; border-radius: 8px; background: rgba(255,255,255,0.05); overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
        .progress-bar-fill { height: 100%; transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 8px; }

        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        @media print { .no-print { display: none !important; } }

        /* Modal de Edi√ß√£o de Pagamentos */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #1e293b; border-radius: 24px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }

        /* Pequenos estilos auxiliares (n√£o altera estrutura) */
        .flag-btn { border: 1px solid rgba(15,23,42,0.12); border-radius: 14px; padding: 10px; transition: .2s; background: #fff; }
        .flag-btn.active { border-color: var(--gold); box-shadow: 0 0 0 4px rgba(251,191,36,.12); }
        .tab-btn { color: rgba(148,163,184,0.9); }
        .tab-active { color: var(--gold); border-bottom: 2px solid var(--gold); }
        .status-badge { width: 10px; height: 10px; border-radius: 999px; display: inline-block; }
        .text-gold { color: var(--gold); }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
        
        /* Nova tag din√¢mica visual para cargos */
        .role-tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; }
        .role-admin { background: rgba(251,191,36,0.2); color: var(--gold); }
        .role-editor { background: rgba(56,189,248,0.2); color: #38bdf8; }
        .role-viewer { background: rgba(148,163,184,0.2); color: #94a3b8; }
    </style>
</head>
<body class="auth-body">

<!-- Login Screen -->
<div id="auth-screen" class="fixed inset-0 z-[2000] flex items-center justify-center p-6">
    <div class="auth-card">
        <div class="logo-box">
             <img src="logo-D2-Group-preto.png" alt="D2 Group" class="h-10 brightness-0 invert">
        </div>
        <h2 class="text-[11px] font-black tracking-[0.3em] mb-10 text-slate-400 uppercase">D2 Project Management Portal</h2>

        <form id="login-form" class="space-y-6 text-left mb-6">
            <div id="login-error-msg" class="hidden p-4 bg-red-50 border border-red-100 rounded-xl text-red-600 text-[10px] font-bold text-center uppercase tracking-widest leading-relaxed">
                Dados inv√°lidos. Caso tenha perdido sua senha ou usu√°rio, procure seu administrador.
            </div>

            <div id="login-hint-msg" class="hidden p-4 bg-amber-50 border border-amber-100 rounded-xl text-amber-700 text-[10px] font-bold text-center uppercase tracking-widest leading-relaxed"></div>

            <div>
                <label class="label-auth">E-mail Corporativo</label>
                <input type="email" id="email" required class="auth-input" placeholder="usuario@allcablingtech.com">
            </div>

            <div class="relative">
                <label class="label-auth">Senha de Acesso</label>
                <input type="password" id="password" required class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <button type="button" onclick="window.togglePassword('password', 'eye-login-btn')" class="password-toggle !text-slate-400" id="eye-login-btn" style="top: 70%;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>

            <button type="submit" id="btn-entrar" class="btn-access">
                <span>Acessar Sistema</span>
            </button>
        </form>

        <div class="mt-8 flex justify-center gap-4">
            <button onclick="setLang('pt')" class="flag-btn active" id="l-pt"><img src="https://flagcdn.com/w80/br.png" class="w-6"></button>
            <button onclick="setLang('en')" class="flag-btn" id="l-en"><img src="https://flagcdn.com/w80/us.png" class="w-6"></button>
        </div>
    </div>
</div>

<!-- Modal de Edi√ß√£o de Pagamentos -->
<div id="edit-payment-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="text-2xl font-black text-gold mb-6">Editar Pagamentos</h3>
        <div id="payment-edit-list" class="space-y-4 mb-6"></div>
        <div class="flex justify-end gap-4">
            <button onclick="closeEditPaymentModal()" class="px-6 py-3 bg-slate-700 text-white rounded-xl font-bold">Cancelar</button>
            <button onclick="saveEditedPayments()" class="btn-premium-gold !w-auto px-8">Salvar Altera√ß√µes</button>
        </div>
    </div>
</div>

<!-- Interface Interna -->
<div id="main-app" class="hidden min-h-screen flex flex-col app-body-dark text-center">
    <header class="no-print bg-white/5 backdrop-blur-md border-b border-white/5 p-4 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-6">
                <div class="bg-white p-2 rounded-xl shadow-md"><img id="header-logo" src="logo-D2-Group-preto.png" class="h-10"></div>
            </div>

            <div class="flex items-center gap-5">
                <button onclick="toggleTheme()" class="p-3 rounded-2xl bg-white/5 hover:bg-gold/20 transition-all"><i data-lucide="sun" id="theme-icon-light" class="hidden text-gold"></i><i data-lucide="moon" id="theme-icon-dark" class="text-slate-400"></i></button>
                <div class="text-right hidden sm:block">
                    <p id="user-display" class="text-xs font-black uppercase text-gold tracking-tight"></p>
                    <p id="user-role-display" class="text-[9px] text-slate-500 font-bold uppercase tracking-widest" data-i18n="admin_panel">Gest√£o Corporativa</p>
                </div>
                <button onclick="handleLogout()" class="p-3 rounded-2xl text-red-500 hover:bg-red-500/10 transition-all border border-red-500/20 shadow-sm"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto w-full p-6 flex-1">
        <nav class="no-print flex gap-10 mb-10 border-b border-white/5 overflow-x-auto justify-center sm:justify-start scrollbar-hide">
            <button onclick="showView('projects')" class="tab-btn pb-4 font-black text-[11px] uppercase tracking-[0.2em] tab-active" id="tab-projects" data-i18n="nav_proj">Projetos</button>
            <button onclick="window.cancelEdit(); showView('new')" class="tab-btn pb-4 font-black text-[11px] uppercase tracking-[0.2em] editor-only hidden" id="tab-new" data-i18n="nav_new">Nova Obra</button>
            <button onclick="showView('reports')" class="tab-btn pb-4 font-black text-[11px] uppercase tracking-[0.2em]" id="tab-reports" data-i18n="nav_rep">Relat√≥rios</button>
            <button onclick="showView('users')" class="tab-btn pb-4 font-black text-[11px] uppercase tracking-[0.2em] admin-only hidden" id="tab-users" data-i18n="nav_users">Equipe</button>
            <button onclick="showView('logs')" class="tab-btn pb-4 font-black text-[11px] uppercase tracking-[0.2em] admin-only hidden" id="tab-logs">üìã Logs</button>
        </nav>

        <div id="view-projects" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10 text-left"></div>

        <div id="view-new" class="hidden max-w-3xl mx-auto glass p-10 rounded-[40px] text-left shadow-2xl border border-white/5">
            <h3 class="text-2xl font-black mb-10 flex items-center gap-4 uppercase tracking-tighter">
                <span class="w-2 h-10 bg-gold rounded-full"></span>
                <span id="form-title" data-i18n="form_new_title">Registrar Obra</span>
            </h3>
            <form id="project-form" class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                <input type="hidden" id="edit-id">

                <div class="col-span-2 md:col-span-1 space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-1 tracking-widest">N¬∫ Proposta</label>
                    <input type="text" id="f-proposta" class="modern-input" placeholder="Ex: PROP-2026-001">
                </div>
                <div class="col-span-2 md:col-span-1 space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-1 tracking-widest">N¬∫ Invoice</label>
                    <input type="text" id="f-invoice" class="modern-input" placeholder="Ex: INV-2026-001">
                </div>

                <div class="col-span-2 space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-1 tracking-widest">Unidade Respons√°vel</label>
                    <select id="f-empresa" class="modern-input"><option value="Smart Home">D2 Smart Home</option><option value="HVAC">D2 HVAC Solutions</option></select>
                </div>
                <div class="col-span-2 md:col-span-1 space-y-2"><label class="text-[10px] font-black uppercase text-slate-500 ml-1 tracking-widest">Cliente</label><input type="text" id="f-cliente" required class="modern-input"></div>
                <div class="col-span-2 md:col-span-1 space-y-2"><label class="text-[10px] font-black uppercase text-slate-500 ml-1 tracking-widest">Vendedor</label><select id="f-vendedor" required class="modern-input"></select></div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-1 tracking-widest">Valor Contrato Bruto</label>
                    <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-gold">$</span><input type="number" id="f-valor" step="0.01" required class="modern-input !pl-8"></div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-1 tracking-widest">% Comiss√£o</label>
                    <div class="relative"><input type="number" id="f-comm" value="5" class="modern-input !pr-10"><span class="absolute right-4 top-1/2 -translate-y-1/2 font-bold text-gold">%</span></div>
                </div>
                <div class="col-span-2 space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-1 tracking-widest">Forma de Pagamento</label>
                    <select id="f-metodo" class="modern-input">
                        <option value="Zelle">Zelle</option>
                        <option value="Wire Transfer">Wire Transfer</option>
                        <option value="Dinheiro">Dinheiro (Cash)</option>
                        <option value="CC">Cart√£o de Cr√©dito (Dedu√ß√£o 3% Net)</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-1 tracking-widest">In√≠cio</label>
                    <div class="date-container" onclick="this.querySelector('input').showPicker()">
                        <input type="date" id="f-inicio" required class="modern-input">
                        <i data-lucide="calendar" class="calendar-icon-overlay w-5 h-5"></i>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-1 tracking-widest">Entrega</label>
                    <div class="date-container" onclick="this.querySelector('input').showPicker()">
                        <input type="date" id="f-entrega" required class="modern-input">
                        <i data-lucide="calendar" class="calendar-icon-overlay w-5 h-5"></i>
                    </div>
                </div>
                <div class="col-span-2 space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-1 tracking-widest">Status</label>
                    <select id="f-status" class="modern-input">
                        <option value="Cota√ß√£o">Cota√ß√£o</option>
                        <option value="‚úÖ Aprovado">‚úÖ Aprovado</option>
                        <option value="Aguardando In√≠cio">Aguardando In√≠cio</option>
                        <option value="Em Execu√ß√£o">Em Execu√ß√£o</option>
                        <option value="Finalizado">Finalizado</option>
                    </select>
                </div>
                <div class="col-span-2 flex gap-6 mt-10">
                    <button type="submit" class="flex-1 btn-premium-gold shadow-xl">Salvar Registro</button>
                    <button type="button" onclick="window.cancelEdit(); showView('projects')" class="px-10 text-slate-500 uppercase font-black text-xs hover:text-white transition-all">Cancelar</button>
                </div>
            </form>
        </div>

        <div id="view-users" class="hidden space-y-10">
            <div class="glass p-10 max-w-lg mx-auto rounded-[32px] text-left border border-white/5 shadow-2xl">
                <h3 class="text-xl font-black text-gold mb-8 uppercase tracking-tighter" data-i18n="team_title">Gest√£o de Equipe</h3>
                <form id="team-form" class="space-y-6">
                    <input type="hidden" id="t-id">
                    
                    <!-- NOVO CAMPO DE AUTORIZA√á√ÉO -->
                    <div class="space-y-1">
                        <label class="label-auth">N√≠vel de Acesso (Autoriza√ß√£o)</label>
                        <select id="t-role" class="modern-input">
                            <option value="editor">Editor Padr√£o (Pode ver, adicionar e editar obras)</option>
                            <option value="viewer">Somente Leitura (Somente ver relat√≥rios e obras)</option>
                            <option value="admin">Administrador (Total Acesso - Logs, Equipe e Edi√ß√µes)</option>
                        </select>
                    </div>

                    <div class="space-y-1"><label class="label-auth">E-mail</label><input type="email" id="t-email" required class="modern-input"></div>
                    <div class="space-y-1 relative">
                        <label class="label-auth">Senha</label>
                        <input type="password" id="t-pass" required class="modern-input">
                        <button type="button" onclick="window.togglePassword('t-pass', 'eye-team-btn')" class="password-toggle" id="eye-team-btn" style="top:70%"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                    </div>
                    
                    <button type="submit" id="btn-save-team" class="btn-premium-gold shadow-xl" data-i18n="btn_team">Salvar e Autorizar Acesso</button>
                </form>
            </div>
            <div id="users-list" class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left max-w-7xl mx-auto"></div>
        </div>

        <div id="view-logs" class="hidden space-y-6 max-w-7xl mx-auto">
            <div class="glass p-8 rounded-[32px] border border-white/5">
                <h3 class="text-2xl font-black text-gold mb-6 uppercase tracking-tighter">üìã Logs de Acesso</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left" id="logs-table">
                        <thead class="border-b border-white/10">
                            <tr>
                                <th class="py-3 px-4 text-[10px] font-black uppercase text-slate-500">Data/Hora</th>
                                <th class="py-3 px-4 text-[10px] font-black uppercase text-slate-500">Usu√°rio</th>
                                <th class="py-3 px-4 text-[10px] font-black uppercase text-slate-500">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="logs-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-reports" class="hidden space-y-8 max-w-7xl mx-auto text-left">
            <div class="flex justify-center gap-4 mb-8 no-print">
                <button onclick="selectUnit('Smart Home')" id="unit-smart" class="unit-pill">SMART HOME</button>
                <button onclick="selectUnit('HVAC')" id="unit-hvac" class="unit-pill">HVAC</button>
                <button onclick="selectUnit('Ambas')" id="unit-all" class="unit-pill active">AMBAS</button>
            </div>
            <div id="report-output"></div>
        </div>
    </main>
</div>

<script type="module">
    import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, updateDoc, addDoc, deleteDoc, onSnapshot, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDrLfIOuBwZblwKPuxBRK3R4fQpjQQbnDE",
        authDomain: "d2-project-management.firebaseapp.com",
        projectId: "d2-project-management",
        storageBucket: "d2-project-management.firebasestorage.app",
        messagingSenderId: "254630664761",
        appId: "1:254630664761:web:0d3c9c840bde488353cbe8"
    };

    const appId = 'd2-Project-Management';
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const SUPER_ADMIN = "dante.frota@allcablingtech.com";

    // Adicionado state.currentUserRole para controlar os poderes e state.team para a lista de vendedores
    let state = { user: null, currentUserRole: 'viewer', projects: [], team: [], company: 'Ambas', lang: 'pt', theme: 'dark', editingPayments: null };

    // Helpers de UI de erro 
    function showLoginError(msg) {
        const box = document.getElementById('login-error-msg');
        const hint = document.getElementById('login-hint-msg');
        if (hint) hint.classList.add('hidden');
        if (box) { box.textContent = msg || 'Falha no login.'; box.classList.remove('hidden'); }
    }
    function showLoginHint(msg) {
        const hint = document.getElementById('login-hint-msg');
        if (!hint) return;
        hint.textContent = msg;
        hint.classList.remove('hidden');
    }
    function hideLoginMessages() {
        document.getElementById('login-error-msg')?.classList.add('hidden');
        document.getElementById('login-hint-msg')?.classList.add('hidden');
    }

    // Log de Acessos
    function logAccess(user, action) {
        const logs = JSON.parse(localStorage.getItem('access_logs') || '[]');
        logs.unshift({ timestamp: new Date().toISOString(), user: user.email || user, action });
        if (logs.length > 500) logs.splice(500);
        localStorage.setItem('access_logs', JSON.stringify(logs));
    }

    function renderLogs() {
        const tbody = document.getElementById('logs-body');
        if (!tbody) return;
        const logs = JSON.parse(localStorage.getItem('access_logs') || '[]');
        tbody.innerHTML = logs.map(log => `
            <tr class="border-b border-white/5 hover:bg-white/5">
                <td class="py-3 px-4 text-sm">${new Date(log.timestamp).toLocaleString('pt-BR')}</td>
                <td class="py-3 px-4 text-sm font-bold text-gold">${log.user}</td>
                <td class="py-3 px-4 text-sm text-slate-400">${log.action}</td>
            </tr>
        `).join('') || '<tr><td colspan="3" class="py-10 text-center text-slate-500">Nenhum log registrado</td></tr>';
    }

    // Gerenciamento Din√¢mico de Autoriza√ß√£o / Permiss√µes
    window.applyPermissions = () => {
        const role = state.currentUserRole;
        const isViewer = role === 'viewer';
        const isEditor = ['editor', 'admin', 'superadmin'].includes(role);
        const isAdmin = ['admin', 'superadmin'].includes(role);

        // Define a tag de exibi√ß√£o do cargo
        const roleDisplay = document.getElementById('user-role-display');
        if (roleDisplay) {
            if (role === 'superadmin') roleDisplay.innerText = "‚≠ê Super Admin";
            else if (role === 'admin') roleDisplay.innerText = "Administrador";
            else if (role === 'editor') roleDisplay.innerText = "Editor";
            else roleDisplay.innerText = "Modo Leitura";
        }

        // Elementos de Admin (Equipe, Logs, Pagamentos)
        document.querySelectorAll('.admin-only').forEach(el => {
            if (isAdmin) el.classList.remove('hidden');
            else el.classList.add('hidden');
        });

        // Elementos de Editor (Aba Nova Obra, Salvar, Editar)
        document.querySelectorAll('.editor-only').forEach(el => {
            if (isEditor) el.classList.remove('hidden');
            else el.classList.add('hidden');
        });
        
        // Re-renderiza os projetos para esconder bot√µes de dentro dos cards se for 'viewer'
        if (state.projects.length > 0) {
            renderProjects();
            renderReport();
        }
    };

    function renderVendedores() {
        const select = document.getElementById('f-vendedor');
        if (!select || !state.user) return;
        const isAdmin = ['admin', 'superadmin'].includes(state.currentUserRole);

        // Guardar o valor selecionado atualmente para n√£o limpar acidentalmente
        const currentValue = select.value;

        select.innerHTML = '';
        if (isAdmin) {
            // Admin pode escolher qualquer membro da equipe
            const uniqueEmails = new Set(state.team.map(m => m.email));
            uniqueEmails.add(state.user.email); // Garante que o admin logado esteja na lista (ex: SuperAdmin)

            uniqueEmails.forEach(email => {
                select.innerHTML += `<option value="${email}">${email}</option>`;
            });
        } else {
            // Usu√°rio comum s√≥ pode escolher a si mesmo
            select.innerHTML = `<option value="${state.user.email}">${state.user.email}</option>`;
        }

        // Define o usu√°rio logado como padr√£o se o campo estiver vazio
        if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
            select.value = currentValue;
        } else {
            select.value = state.user.email;
        }
    }

    window.openEditPaymentModal = (projectId) => {
        const p = state.projects.find(x => x.id === projectId);
        if (!p) return;
        state.editingPayments = { projectId, payments: [...(p.pagamentosEfetuados || [])] };
        renderPaymentEditList();
        document.getElementById('edit-payment-modal').classList.add('active');
    };

    window.closeEditPaymentModal = () => {
        state.editingPayments = null;
        document.getElementById('edit-payment-modal').classList.remove('active');
    };

    function renderPaymentEditList() {
        const container = document.getElementById('payment-edit-list');
        if (!container || !state.editingPayments) return;
        container.innerHTML = state.editingPayments.payments.map((pay, i) => `
            <div class="flex items-center gap-4 p-4 bg-white/5 rounded-xl border border-white/10">
                <input type="date" value="${pay.data || ''}" onchange="updatePaymentField(${i}, 'data', this.value)" class="modern-input flex-1">
                <input type="number" step="0.01" value="${(pay.valor ?? 0)}" onchange="updatePaymentField(${i}, 'valor', this.value)" class="modern-input flex-1">
                <button onclick="removePaymentFromEdit(${i})" class="p-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
        `).join('') + `
            <button onclick="addNewPaymentToEdit()" class="w-full p-4 border-2 border-dashed border-gold/30 rounded-xl text-gold font-bold hover:bg-gold/10 transition-all">
                + Adicionar Novo Pagamento
            </button>
        `;
        try { lucide.createIcons(); } catch {}
    }

    window.updatePaymentField = (index, field, value) => {
        if (!state.editingPayments) return;
        if (field === 'data') state.editingPayments.payments[index].data = value;
        if (field === 'valor') state.editingPayments.payments[index].valor = parseFloat(value || 0);
    };

    window.removePaymentFromEdit = (index) => {
        if (!confirm('Remover este pagamento?')) return;
        state.editingPayments.payments.splice(index, 1);
        renderPaymentEditList();
    };

    window.addNewPaymentToEdit = () => {
        if (!state.editingPayments) return;
        state.editingPayments.payments.push({ data: new Date().toISOString().split('T')[0], valor: 0 });
        renderPaymentEditList();
    };

    window.saveEditedPayments = async () => {
        if (!state.editingPayments) return;
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', state.editingPayments.projectId), {
                pagamentosEfetuados: state.editingPayments.payments
            });
            closeEditPaymentModal();
        } catch (e) {
            alert('Erro ao salvar pagamentos: ' + e.message);
        }
    };

    const translations = {
        pt: {
            login_sub: "Sistema Integrado de Gest√£o", login_err: "Dados inv√°lidos. Procure seu administrador.",
            btn_login: "Acessar Sistema", admin_panel: "Gest√£o Corporativa", nav_proj: "Projetos", nav_new: "Nova Obra", nav_rep: "Relat√≥rios", nav_users: "Equipe",
            form_new_title: "Registrar Obra", label_div: "Unidade", label_client: "Cliente", label_seller: "Vendedor", label_value: "Contrato",
            label_comm: "Comiss√£o", label_method: "Pagamento", label_start: "In√≠cio", label_end: "Entrega", label_status: "Status",
            btn_save: "Salvar Registro", team_title: "Gest√£o de Equipe", btn_team: "Salvar e Autorizar Acesso",
            timeline: "Timeline", status_overdue: "ATRASADA", status_finished: "CONCLU√çDA", days_left: "DIAS RESTANTES",
            finance_btn: "FINANCEIRO VENDEDOR", net_base: "L√≠quido", balance: "Saldo", history: "Hist√≥rico de Pagamentos", report_title: "RELAT√ìRIO EXECUTIVO",
            overpaid: "PAGO A MAIOR (CR√âDITO)", paid_full: "TOTALMENTE PAGO", balance_due: "SALDO A PAGAR", summary_title: "Comiss√µes por Vendedor"
        },
        en: {
            login_sub: "Integrated Management System", login_err: "Invalid credentials. Contact administrator.",
            btn_login: "Access System", admin_panel: "Corporate Management", nav_proj: "Projects", nav_new: "New Entry", nav_rep: "Reports", nav_users: "Team",
            form_new_title: "Register Project", label_div: "Unit", label_client: "Client", label_seller: "Sales Rep", label_value: "Contract",
            label_comm: "Commission", label_method: "Payment", label_start: "Start", label_end: "Deadline", label_status: "Status",
            btn_save: "Save Entry", team_title: "Team Management", btn_team: "Authorize Access",
            timeline: "Timeline", status_overdue: "OVERDUE", status_finished: "FINISHED", days_left: "DAYS LEFT",
            finance_btn: "SALES FINANCE", net_base: "Net", balance: "Balance", history: "Payment History", report_title: "EXECUTIVE REPORT",
            overpaid: "OVERPAID (CREDIT)", paid_full: "PAID IN FULL", balance_due: "BALANCE DUE", summary_title: "Commissions by Seller"
        }
    };

    const formatCurr = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(Number(v || 0));

    window.togglePassword = (inputId, btnId) => {
        const el = document.getElementById(inputId);
        const btn = document.getElementById(btnId);
        if (el && btn) {
            const isPass = el.type === 'password';
            el.type = isPass ? 'text' : 'password';
            btn.innerHTML = isPass
                ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>'
                : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
        }
    };

    window.setLang = (l) => {
        state.lang = l;
        document.querySelectorAll('.flag-btn').forEach(b => b.classList.toggle('active', b.id.includes(l)));
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[l] && translations[l][key]) el.innerText = translations[l][key];
        });
        renderProjects();
        renderReport();
    };

    window.selectUnit = (unit) => {
        state.company = unit;
        document.querySelectorAll('.unit-pill').forEach(b => b.classList.remove('active'));
        const map = { 'Smart Home': 'unit-smart', 'HVAC': 'unit-hvac', 'Ambas': 'unit-all' };
        document.getElementById(map[unit]).classList.add('active');
        renderProjects();
        renderReport();
    };

    window.toggleTheme = () => {
        state.theme = state.theme === 'dark' ? 'light' : 'dark';
        const appDiv = document.getElementById('main-app');
        if (appDiv) appDiv.className = state.theme === 'dark'
            ? 'min-h-screen flex flex-col app-body-dark text-center'
            : 'min-h-screen flex flex-col app-body-light light text-center';

        const sun = document.getElementById('theme-icon-light');
        const moon = document.getElementById('theme-icon-dark');
        if (sun && moon) {
            if (state.theme === 'dark') { sun.classList.add('hidden'); moon.classList.remove('hidden'); }
            else { moon.classList.add('hidden'); sun.classList.remove('hidden'); }
        }
        try { lucide.createIcons(); } catch {}
    };

    window.toggleFinance = (id) => {
        const el = document.getElementById(`fin-${id}`);
        if (el) el.classList.toggle('open');
    };

    window.addPayment = async (projectId) => {
        if (!state.user) return;
        const v = document.getElementById(`pay-val-${projectId}`)?.value;
        const d = document.getElementById(`pay-date-${projectId}`)?.value;
        if (!v || !d) return;
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', projectId), {
                pagamentosEfetuados: arrayUnion({ valor: parseFloat(v), data: d })
            });
        } catch (e) { console.error(e); }
    };

    window.editTeamMember = (id, email, pass, role) => {
        document.getElementById('t-id').value = id;
        document.getElementById('t-email').value = email;
        document.getElementById('t-pass').value = pass;
        // Seleciona a autoriza√ß√£o do banco, ou default "editor"
        document.getElementById('t-role').value = role || 'editor';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.deleteTeam = async (id) => {
        if (confirm("REMOVER ACESSO DESTE MEMBRO?")) {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_credentials', id));
        }
    };
    window.deleteP = async (id) => {
        if (confirm("EXCLUIR ESTA OBRA?")) {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', id));
        }
    };

    window.editP = (id) => {
        const p = state.projects.find(x => x.id === id);
        if (!p) return;
        
        // Recarrega a lista original para evitar ac√∫mulo de op√ß√µes antigas ao editar v√°rios projetos
        renderVendedores();
        
        // Garante que o vendedor atual exista na lista do select (para compatibilidade com cadastros antigos em texto)
        const vendSelect = document.getElementById('f-vendedor');
        if (p.vendedor && !Array.from(vendSelect.options).some(opt => opt.value === p.vendedor)) {
            vendSelect.innerHTML += `<option value="${p.vendedor}">${p.vendedor} (Cadastro Antigo)</option>`;
        }

        document.getElementById('edit-id').value = id;
        document.getElementById('f-proposta').value = p.numeroProposta || '';
        document.getElementById('f-invoice').value = p.numeroInvoice || '';
        document.getElementById('f-empresa').value = p.empresa || 'Smart Home';
        document.getElementById('f-cliente').value = p.cliente || '';
        document.getElementById('f-vendedor').value = p.vendedor || '';
        document.getElementById('f-valor').value = p.valorTotal ?? '';
        document.getElementById('f-comm').value = p.percComissao ?? 5;
        document.getElementById('f-metodo').value = p.metodo || 'Zelle';
        document.getElementById('f-inicio').value = p.dataInicio || '';
        document.getElementById('f-entrega').value = p.dataEntrega || '';
        document.getElementById('f-status').value = p.status || 'Cota√ß√£o';
        window.showView('new');
    };

    // Nova fun√ß√£o para garantir o formul√°rio limpo e o Vendedor Padr√£o ao cancelar/novo
    window.cancelEdit = () => {
        const form = document.getElementById('project-form');
        if (form) form.reset();
        document.getElementById('edit-id').value = '';
        const fVendedor = document.getElementById('f-vendedor');
        if (fVendedor && state.user) fVendedor.value = state.user.email;
    };

    window.showView = (v) => {
        ['projects', 'new', 'reports', 'users', 'logs'].forEach(id => {
            const el = document.getElementById('view-' + id);
            const tab = document.getElementById('tab-' + id);
            if (el) el.classList.add('hidden');
            if (tab) tab.classList.remove('tab-active');
        });
        const tv = document.getElementById('view-' + v);
        const tt = document.getElementById('tab-' + v);
        if (tv) tv.classList.remove('hidden');
        if (tt) tt.classList.add('tab-active');

        if (v === 'logs') renderLogs();
        try { lucide.createIcons(); } catch {}
    };

    window.handleLogout = () => signOut(auth).then(() => location.reload()).catch(console.error);

    function getFin(p) {
        const metodo = String(p?.metodo || '');
        const isCC = (metodo === 'CC' || metodo.toLowerCase().includes('cart√£o'));
        const valorTotal = Number(p?.valorTotal || 0);

        const base = isCC ? valorTotal * 0.97 : valorTotal;
        const commTotal = base * (Number(p?.percComissao || 0) / 100);

        const pays = Array.isArray(p?.pagamentosEfetuados) ? p.pagamentosEfetuados : [];
        const totalPaid = pays.reduce((a, c) => a + Number(c?.valor || 0), 0);

        const balance = commTotal - totalPaid;
        
        let statusColor = "bg-red-500";
        if (balance < 0) statusColor = "bg-blue-500"; // Pago a maior (Azul)
        else if (balance === 0) statusColor = "bg-emerald-500"; // Totalmente Pago (Verde)
        else if (totalPaid > 0) statusColor = "bg-orange-500"; // Parcialmente Pago (Laranja)

        return { base, commTotal, totalPaid, balance, statusColor, isCC };
    }

    function renderProjects() {
        const grid = document.getElementById('view-projects');
        if (!grid || !state.user) return;

        grid.innerHTML = '';
        const t = translations[state.lang];

        // Verificar o perfil
        const isEditor = ['editor', 'admin', 'superadmin'].includes(state.currentUserRole);
        const isAdmin = ['admin', 'superadmin'].includes(state.currentUserRole);

        const filtered = state.projects.filter(p => {
            const matchCompany = state.company === 'Ambas' || p.empresa === state.company;
            const matchUser = isAdmin || p.vendedor === state.user.email; // Filtro de Vendedor (Suas Obras vs Todas)
            return matchCompany && matchUser;
        });

        filtered.forEach(p => {
            const s = new Date(p.dataInicio).getTime();
            const e = new Date(p.dataEntrega).getTime();
            const n = Date.now();

            let prog = (Number.isFinite(s) && Number.isFinite(e) && e > s)
                ? (n >= s ? (n > e ? 100 : Math.floor(((n - s) / (e - s)) * 100)) : 0)
                : 0;

            let r, g;
            if (prog < 50) { r = (prog * 5.1); g = 255; }
            else { r = 255; g = (255 - (prog - 50) * 5.1); }

            let colorHex = `rgb(${Math.floor(r)}, ${Math.floor(g)}, 0)`;
            if (n > e && p.status !== 'Finalizado') colorHex = 'rgb(180, 0, 0)';

            const f = getFin(p);
            const propInvoiceInfo = (p.numeroProposta || p.numeroInvoice)
                ? `<div class="text-[9px] text-slate-500 mt-1">${p.numeroProposta ? 'Prop: ' + p.numeroProposta : ''}${p.numeroProposta && p.numeroInvoice ? ' ‚Ä¢ ' : ''}${p.numeroInvoice ? 'Inv: ' + p.numeroInvoice : ''}</div>`
                : '';

            let balText = t.balance_due;
            let balColor = "text-red-400";
            let balDisplay = formatCurr(f.balance);

            if (f.balance < 0) {
                balText = t.overpaid;
                balColor = "text-blue-400";
                balDisplay = "+ " + formatCurr(Math.abs(f.balance));
            } else if (f.balance === 0) {
                balText = t.paid_full;
                balColor = "text-emerald-400";
            }

            grid.innerHTML += `<div class="glass p-8 rounded-[40px] border-l-[8px] relative shadow-2xl" style="border-left-color: ${p.status === 'Finalizado' ? '#10b981' : '#f59e0b'}">
                <div class="absolute top-6 right-6 flex items-center gap-3">
                    <span class="status-badge ${f.statusColor}"></span>
                    ${isEditor ? `
                    <button onclick="window.editP('${p.id}')"><i data-lucide="edit-3" class="w-4 h-4 text-slate-400"></i></button>
                    <button onclick="window.deleteP('${p.id}')"><i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i></button>
                    ` : ''}
                </div>

                <div class="mb-6 text-left">
                    <h4 class="font-black text-xl uppercase truncate pr-20">${p.cliente || ''}</h4>
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">${p.vendedor || ''} ‚Ä¢ ${p.metodo || ''}</p>
                    ${propInvoiceInfo}
                </div>

                <div class="space-y-3 mb-8 text-left">
                    <div class="flex justify-between text-[10px] font-black uppercase text-slate-400"><span>${t.timeline}</span><span style="color: ${colorHex}">${prog}%</span></div>
                    <div class="progress-track"><div class="progress-bar-fill" style="width: ${prog}%; background-color: ${colorHex}; ${n > e && p.status !== 'Finalizado' ? 'animation: pulse 1s infinite' : ''}"></div></div>
                    <div class="flex justify-between text-[9px] font-extrabold uppercase">
                        <span>${p.dataInicio ? new Date(p.dataInicio).toLocaleDateString() : '-'}</span>
                        <span class="${n > e && p.status !== 'Finalizado' ? 'text-red-500' : 'text-gold'}">
                            ${n > e && p.status !== 'Finalizado'
                                ? t.status_overdue
                                : (prog === 100 ? t.status_finished : (Number.isFinite(e) ? Math.ceil((e - n) / (1000 * 3600 * 24)) : 0) + ' ' + t.days_left)}
                        </span>
                    </div>
                </div>

                <div class="bg-black/30 p-6 rounded-3xl border border-white/5 shadow-inner"><p class="text-[9px] font-black text-slate-500 uppercase mb-1 text-center">Valor do Contrato</p><p class="text-2xl font-black text-white text-center">${formatCurr(p.valorTotal)}</p></div>

                <button onclick="window.toggleFinance('${p.id}')" class="w-full mt-6 py-2 text-[10px] font-black uppercase text-gold hover:underline flex items-center justify-center gap-2"><i data-lucide="wallet" class="w-4 h-4"></i> ${t.finance_btn}</button>

                <div id="fin-${p.id}" class="finance-panel">
                    <div class="bg-gold/5 p-4 rounded-2xl border border-gold/10 space-y-4 text-left">
                        <div class="flex justify-between">
                            <div><p class="text-[8px] font-bold text-gold/60 uppercase">Comiss√£o Total ${f.isCC ? '(Net -3%)' : ''}</p><p class="text-lg font-black text-gold">${formatCurr(f.commTotal)}</p></div>
                            <div class="text-right"><p class="text-[8px] font-bold text-gold/60 uppercase">${balText}</p><p class="text-lg font-black ${balColor}">${balDisplay}</p></div>
                        </div>

                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <p class="text-[9px] font-black text-slate-500 uppercase border-b border-white/5 pb-1">${t.history}</p>
                                ${isAdmin ? `<button onclick="openEditPaymentModal('${p.id}')" class="text-[9px] font-bold text-gold hover:underline">‚úèÔ∏è Editar</button>` : ''}
                            </div>
                            <div class="max-h-32 overflow-y-auto scrollbar-hide">
                                ${(p.pagamentosEfetuados || []).map(pay => `<div class="flex justify-between text-[10px] py-1 border-b border-white/5"><span>${pay.data ? new Date(pay.data).toLocaleDateString() : '-'}</span><span class="font-bold text-emerald-500">+ ${formatCurr(pay.valor)}</span></div>`).join('') || '<p class="text-[9px] italic opacity-50">Sem hist√≥rico</p>'}
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-white/5 admin-only ${!isAdmin ? 'hidden' : ''}">
                            <div class="grid grid-cols-2 gap-2"><input type="number" id="pay-val-${p.id}" placeholder="$" class="modern-input !pl-4 h-10"><input type="date" id="pay-date-${p.id}" class="modern-input !pl-4 h-10"></div>
                            <button onclick="window.addPayment('${p.id}')" class="w-full mt-2 btn-premium-gold !py-2 !text-[9px]">Lan√ßar Pagamento</button>
                        </div>
                    </div>
                </div>
            </div>`;
        });

        try { lucide.createIcons(); } catch {}
    }

    function renderReport() {
        const out = document.getElementById('report-output');
        if (!out || !state.user) return;

        const t = translations[state.lang];
        let tv = 0, tc = 0;

        const isAdmin = ['admin', 'superadmin'].includes(state.currentUserRole);

        const filtered = state.projects.filter(p => {
            const matchCompany = state.company === 'Ambas' || p.empresa === state.company;
            const matchUser = isAdmin || p.vendedor === state.user.email; // Filtro de Vendedor (Suas Obras vs Todas)
            return matchCompany && matchUser;
        });

        // Configura√ß√£o para o Resumo por Vendedor
        const currentYear = new Date().getFullYear();
        const monthNames = state.lang === 'en'
            ? ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']
            : ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
        
        const sellerStats = {};

        const rows = filtered.map(p => {
            const f = getFin(p);
            tv += Number(p.valorTotal || 0);
            tc += Number(f.commTotal || 0);

            // Popula Estat√≠sticas do Vendedor m√™s a m√™s
            const vend = p.vendedor || 'Sem Vendedor';
            if (!sellerStats[vend]) {
                sellerStats[vend] = { total: 0, months: Array(12).fill(0) };
            }

            if (p.dataInicio) {
                const [yearStr, monthStr] = p.dataInicio.split('-');
                const pYear = parseInt(yearStr, 10);
                const pMonth = parseInt(monthStr, 10) - 1;

                if (pYear === currentYear) {
                    sellerStats[vend].months[pMonth] += f.commTotal;
                    sellerStats[vend].total += f.commTotal;
                }
            }

            const s = new Date(p.dataInicio).getTime();
            const e = new Date(p.dataEntrega).getTime();
            const n = Date.now();

            let prog = (Number.isFinite(s) && Number.isFinite(e) && e > s)
                ? (n >= s ? (n > e ? 100 : Math.floor(((n - s) / (e - s)) * 100)) : 0)
                : 0;

            return `<tr class="border-b border-slate-100 text-xs text-left text-slate-800">
                <td class="p-4 font-mono text-[10px]">${p.numeroProposta || '-'}</td>
                <td class="p-4 font-mono text-[10px]">${p.numeroInvoice || '-'}</td>
                <td class="p-4 font-black uppercase">${p.cliente || ''}</td>
                <td class="p-4">${p.vendedor || ''}</td>
                <td class="p-4 text-center">${prog}%</td>
                <td class="p-4 text-right">${formatCurr(p.valorTotal)}</td>
                <td class="p-4 text-right text-slate-400 italic">${formatCurr(f.base)}</td>
                <td class="p-4 text-right font-black text-amber-600">${formatCurr(f.commTotal)}</td>
            </tr>`;
        }).join('');

        // Monta a Tabela de Resumo dos Vendedores
        let summaryRows = Object.keys(sellerStats).sort().map(vend => {
            const stats = sellerStats[vend];
            let monthsHtml = stats.months.map(mVal => `<td class="p-3 text-right ${mVal > 0 ? 'text-amber-600 font-bold' : 'text-slate-300'}">${formatCurr(mVal)}</td>`).join('');
            return `<tr class="border-b border-slate-100 text-[10px] text-slate-800">
                <td class="p-3 font-black uppercase whitespace-nowrap">${vend.split('@')[0]}</td>
                ${monthsHtml}
                <td class="p-3 text-right font-black text-emerald-600 bg-slate-50">${formatCurr(stats.total)}</td>
            </tr>`;
        }).join('');

        let summaryHeaderMonths = monthNames.map(m => `<th class="p-3 text-right">${m}</th>`).join('');

        const summaryTableHtml = `
            <div class="mb-12">
                <h3 class="text-lg font-black uppercase tracking-tighter mb-4 text-slate-800">${t.summary_title} (${currentYear})</h3>
                <div class="overflow-x-auto border border-slate-100 rounded-2xl">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr class="font-black uppercase text-[9px] text-slate-500 text-left">
                                <th class="p-3">Vendedor</th>
                                ${summaryHeaderMonths}
                                <th class="p-3 text-right bg-slate-100">Total Ano</th>
                            </tr>
                        </thead>
                        <tbody>${summaryRows || `<tr><td colspan="14" class="p-4 text-center text-slate-400">Nenhum dado para o ano atual.</td></tr>`}</tbody>
                    </table>
                </div>
            </div>
        `;

        out.innerHTML = `<div class="bg-white text-slate-950 p-12 rounded-[50px] shadow-2xl border-8 border-slate-50 text-left">
            <div class="flex justify-between items-center border-b-[8px] border-slate-950 pb-10 mb-10">
                <div class="logo-frame-sm border p-2 rounded-xl"><img src="logo-D2-Group-preto.png" class="h-12"></div>
                <div class="text-right">
                    <h2 class="text-3xl font-black uppercase tracking-tighter">${t.report_title}</h2>
                    <p class="text-slate-400 font-black uppercase text-[10px]">${new Date().toLocaleDateString()}</p>
                </div>
            </div>
            
            ${summaryTableHtml}
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-slate-50 font-black uppercase text-[10px] text-slate-500 text-left">
                            <th class="p-4">N¬∫ Prop.</th><th class="p-4">N¬∫ Inv.</th><th class="p-4">Obra</th><th class="p-4">Vendedor</th>
                            <th class="p-4 text-center">Prog. (%)</th><th class="p-4 text-right">Contrato</th><th class="p-4 text-right">L√≠quido</th><th class="p-4 text-right">Comiss√£o</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
            <div class="mt-10 pt-10 border-t-[8px] border-slate-950 flex justify-end gap-16">
                <div class="text-right">
                    <p class="text-[11px] font-black uppercase text-slate-400 mb-1">TOTAL GERAL</p>
                    <p class="text-4xl font-black">${formatCurr(tv)}</p>
                </div>
                <div class="text-right">
                    <p class="text-[11px] font-black uppercase text-amber-600 mb-1">COMISS√ïES TOTAIS</p>
                    <p class="text-4xl font-black text-amber-600">${formatCurr(tc)}</p>
                </div>
            </div>
        </div>`;
    }

    onAuthStateChanged(auth, (u) => {
        state.user = u;

        if (u) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.body.className = 'app-body-dark';

            document.getElementById('user-display').innerText = u.email ? u.email.split('@')[0].toUpperCase() : "USR";
            
            initData();
            logAccess(u.email, 'Login');
        } else {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.body.className = 'auth-body';
        }

        window.setLang(state.lang);
        try { lucide.createIcons(); } catch {}
    });

    function initData() {
        if (!auth.currentUser) return;

        // Monitorar Projetos Unificado
        const projectsRef = collection(db, 'artifacts', appId, 'public', 'data', 'projects');
        onSnapshot(projectsRef, snap => {
            state.projects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderProjects();
            renderReport();
        }, err => console.error(err));

        // Monitorar Equipe Globalmente e Proteger a Entrada
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'user_credentials'), snap => {
            if (!auth.currentUser) return; // Seguran√ßa extra em caso de logoff
            
            const team = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            state.team = team;
            
            // Decidir Permiss√£o do Usu√°rio Logado
            if (auth.currentUser.email.toLowerCase() === SUPER_ADMIN.toLowerCase()) {
                state.currentUserRole = 'superadmin';
            } else {
                const myProfile = team.find(u => u.email.toLowerCase() === auth.currentUser.email.toLowerCase());
                
                // BARREIRA DE SEGURAN√áA: Se o e-mail n√£o estiver na lista (Gest√£o de Equipe), bloqueia na hora!
                if (!myProfile) {
                    alert("Acesso Negado: Seu e-mail n√£o foi autorizado pelo administrador do sistema.");
                    signOut(auth);
                    return;
                }
                
                state.currentUserRole = myProfile?.role || 'viewer';
            }
            
            // Aplica visibilidade baseada na nova Role e Preenche o Dropdown de Vendedores
            window.applyPermissions();
            renderVendedores();

            // Renderiza painel de ger√™ncia se for um Admin
            const container = document.getElementById('users-list');
            if (container && ['admin', 'superadmin'].includes(state.currentUserRole)) {
                container.innerHTML = team.map(u => {
                    let roleStr = "Editor Padr√£o", roleClass = "role-editor";
                    if(u.role === 'admin' || u.email.toLowerCase() === SUPER_ADMIN.toLowerCase()) { roleStr = "Admin"; roleClass = "role-admin"; }
                    if(u.role === 'viewer') { roleStr = "Modo Leitura"; roleClass = "role-viewer"; }
                    
                    return `<div class="glass p-6 rounded-[24px] flex justify-between items-center border-l-8 border-gold shadow-lg transition-all hover:scale-[1.01]">
                    <div class="text-left">
                        <p class="font-black text-slate-100 text-lg flex items-center gap-2">${u.email} <span class="role-tag ${roleClass}">${roleStr}</span></p>
                        <p class="text-[11px] text-slate-500 mt-1 uppercase tracking-widest">Senha: <span class="text-gold font-bold normal-case">${u.password}</span></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.editTeamMember('${u.id}', '${u.email}', '${u.password}', '${u.role}')" class="p-2 text-gold hover:bg-gold/10 rounded-lg"><i data-lucide="edit" size="18"></i></button>
                        <button onclick="window.deleteTeam('${u.id}')" class="p-2 text-red-500 hover:bg-red-500/10 rounded-lg ${u.email.toLowerCase() === SUPER_ADMIN.toLowerCase() ? 'hidden' : ''}"><i data-lucide="user-minus" size="18"></i></button>
                    </div></div>`
                }).join('');
                try { lucide.createIcons(); } catch {}
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        try { lucide.createIcons(); } catch {}

        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            hideLoginMessages();

            const btn = document.getElementById('btn-entrar');
            btn.disabled = true;

            const email = document.getElementById('email').value.trim();
            const pass = document.getElementById('password').value;

            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                // Removemos o console.error propositalmente para n√£o causar alarmismo
                if (err?.code === 'auth/invalid-credential' || err?.code === 'auth/user-not-found') {
                    
                    // Tenta criar automaticamente caso o administrador tenha adicionado a pessoa apenas no Firestore
                    try {
                        await createUserWithEmailAndPassword(auth, email, pass);
                        return; // Sucesso na cria√ß√£o e login na mesma hora!
                    } catch (createErr) {
                        // Se o e-mail j√° existe na Auth, mas a senha estava errada (isso acontece em contas j√° registradas)
                        if (createErr.code === 'auth/email-already-in-use') {
                            showLoginError('Senha incorreta.');
                        } else {
                            showLoginError('Dados inv√°lidos ou e-mail j√° cadastrado de forma incompat√≠vel.');
                        }
                    }
                    
                } else if (err?.code === 'auth/unauthorized-domain') {
                    showLoginError('Dom√≠nio n√£o autorizado no Firebase Auth. Configure no painel do Firebase.');
                } else {
                    showLoginError('Falha no login: ' + err.message);
                }
            } finally {
                btn.disabled = false;
            }
        };

        document.getElementById('project-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!auth.currentUser) return;

            const id = document.getElementById('edit-id').value;
            const d = {
                numeroProposta: document.getElementById('f-proposta').value || '',
                numeroInvoice: document.getElementById('f-invoice').value || '',
                empresa: document.getElementById('f-empresa').value,
                cliente: document.getElementById('f-cliente').value,
                vendedor: document.getElementById('f-vendedor').value,
                valorTotal: parseFloat(document.getElementById('f-valor').value),
                metodo: document.getElementById('f-metodo').value,
                percComissao: parseInt(document.getElementById('f-comm').value),
                dataInicio: document.getElementById('f-inicio').value,
                dataEntrega: document.getElementById('f-entrega').value,
                status: document.getElementById('f-status').value,
                updatedAt: serverTimestamp()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', id), d);
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), { ...d, createdAt: serverTimestamp(), pagamentosEfetuados: [] });
                }
                e.target.reset();
                document.getElementById('edit-id').value = '';
                document.getElementById('f-vendedor').value = auth.currentUser.email; // Restaura o vendedor padr√£o
                window.showView('projects');
            } catch (err) {
                console.error(err);
            }
        };

        document.getElementById('team-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!auth.currentUser) return;

            const id = document.getElementById('t-id').value;
            const mail = document.getElementById('t-email').value.trim();
            const pass = document.getElementById('t-pass').value;
            const role = document.getElementById('t-role').value; // Pegando a role

            try {
                // Tenta criar o usu√°rio no Firebase Auth usando um app secund√°rio (com limpeza para evitar leaks de mem√≥ria)
                try {
                    const secApp = initializeApp(firebaseConfig, "SecApp_" + Date.now());
                    const secAuth = getAuth(secApp);
                    await createUserWithEmailAndPassword(secAuth, mail, pass);
                    await signOut(secAuth);
                    await deleteApp(secApp); // <- Limpeza implementada aqui!
                } catch (authErr) {
                    // Ignora silenciosamente. O auto-registro no login vai cuidar do resto se a conta falhar.
                }

                if (!id) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'user_credentials'), { email: mail, password: pass, role: role, updatedAt: serverTimestamp() });
                } else {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_credentials', id), { email: mail, password: pass, role: role, updatedAt: serverTimestamp() });
                }
                e.target.reset();
                document.getElementById('t-id').value = '';
            } catch (err) {
                alert("Erro: " + err.message);
            }
        };
    });
</script>
</body>
</html>