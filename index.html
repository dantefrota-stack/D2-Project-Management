<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D2 Management System - Official</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
        }
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0f1e;
            color: #f1f5f9;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }
        .glass { 
            background: var(--glass); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid var(--border); 
            border-radius: 24px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .glass-input { 
            background: rgba(0, 0, 0, 0.3); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            color: white; 
            padding: 12px 16px; 
            width: 100%; 
            outline: none; 
            transition: all 0.3s ease; 
        }
        .glass-input:focus { 
            border-color: #fbbf24; /* Gold-ish accent to match logo */
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2);
        }
        .btn-action { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border-radius: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
        }
        .btn-action:active { transform: scale(0.97); }
        .tab-btn { padding-bottom: 12px; border-bottom: 3px solid transparent; color: #64748b; transition: all 0.3s; cursor: pointer; }
        .tab-btn.active { color: #fbbf24; border-bottom-color: #fbbf24; }
        
        .logo-header { max-height: 45px; width: auto; transition: opacity 0.3s ease; }
        .logo-login { max-width: 280px; height: auto; margin-bottom: 2rem; }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .glass { border: 1px solid #eee !important; background: transparent !important; box-shadow: none !important; border-radius: 0 !important; }
            #report-output { display: block !important; padding: 0 !important; }
            .report-card { border: none !important; }
        }
        
        .flag-btn { font-size: 1.5rem; filter: grayscale(1); opacity: 0.5; transition: all 0.2s; cursor: pointer; border: none; background: none; }
        .flag-btn:hover, .flag-btn.active { filter: grayscale(0); opacity: 1; transform: scale(1.1); }
        .log-row:nth-child(even) { background: rgba(255,255,255,0.01); }
        .pass-list-input { background: transparent; border: none; color: #94a3b8; font-size: 0.875rem; width: 140px; outline: none; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0f1e; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #334155; }
    </style>
</head>
<body>

<!-- Authentication Overlay -->
<div id="auth-container" class="fixed inset-0 z-50 flex items-center justify-center bg-[#070b14] p-6">
    <div class="glass p-10 w-full max-w-md text-center">
        <img src="logo-D2-Group-preto.png" alt="D2 Group" class="logo-login mx-auto" onerror="this.src='https://placehold.co/400x150/0a0f1e/fbbf24?text=D2+GROUP'">
        
        <p id="auth-subtitle" class="text-slate-400 text-sm mb-8 font-medium" data-i18n="login_subtitle">Fa√ßa login para gerenciar suas divis√µes</p>
        
        <form id="login-form" onsubmit="handleAuth(event)" class="space-y-5 text-left">
            <div>
                <label class="text-[11px] text-slate-500 uppercase font-bold tracking-wider block mb-1.5 ml-1">E-mail</label>
                <input type="email" id="auth-email" required class="glass-input" placeholder="exemplo@d2group.com">
            </div>
            <div class="relative">
                <label class="text-[11px] text-slate-500 uppercase font-bold tracking-wider block mb-1.5 ml-1" data-i18n="field_password">Senha</label>
                <input type="password" id="auth-password" required class="glass-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <button type="button" onclick="togglePasswordVisibility('auth-password')" class="absolute right-4 top-9 text-slate-500 hover:text-white transition-colors">
                    üëÅÔ∏è
                </button>
            </div>
            <button type="submit" class="w-full bg-gradient-to-r from-amber-500 to-yellow-600 hover:from-amber-400 hover:to-yellow-500 text-white p-4 btn-action mt-6 shadow-lg shadow-amber-900/20" data-i18n="btn_login">
                Entrar no Sistema
            </button>
            <button type="button" onclick="resetPassword()" class="w-full text-xs text-slate-500 hover:text-amber-400 mt-4 transition-colors" data-i18n="forgot_password">Esqueceu a senha?</button>
        </form>
    </div>
</div>

<!-- Main Application -->
<div id="app-container" class="hidden min-h-screen flex flex-col">
    <header class="no-print sticky top-0 z-40 bg-[#0a0f1e]/80 backdrop-blur-xl border-b border-white/5 p-4">
        <div class="max-w-7xl mx-auto flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-6">
                <img id="header-logo" src="logo-D2-SmartHome-preto.png" alt="D2 Logo" class="logo-header" onerror="this.src='https://placehold.co/200x50/0a0f1e/fbbf24?text=D2+Logo'">
                <div class="h-8 w-px bg-white/10 hidden sm:block"></div>
                <div class="flex gap-2">
                    <button onclick="setLanguage('pt')" id="lang-pt" class="flag-btn active" title="Portugu√™s">üáßüá∑</button>
                    <button onclick="setLanguage('en')" id="lang-en" class="flag-btn" title="English">üá∫üá∏</button>
                    <button onclick="setLanguage('es')" id="lang-es" class="flag-btn" title="Espa√±ol">üá™üá∏</button>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex bg-black/40 p-1.5 rounded-2xl border border-white/5 text-[11px] font-bold uppercase tracking-tight">
                    <button onclick="switchCompany('Smart Home')" id="btn-smart" class="px-4 py-2 rounded-xl transition-all bg-amber-600 text-white">Smart Home</button>
                    <button onclick="switchCompany('HVAC')" id="btn-hvac" class="px-4 py-2 rounded-xl transition-all text-slate-400">HVAC Solutions</button>
                </div>
                <div class="flex items-center gap-3 border-l border-white/10 pl-4">
                    <span id="user-display" class="hidden lg:inline text-xs font-semibold text-slate-400"></span>
                    <button onclick="logout()" class="text-red-400 hover:text-red-300 p-2.5 glass rounded-xl transition-colors" title="Sair">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto w-full p-4 md:p-8 flex-1">
        <!-- Navigation Tabs -->
        <div class="no-print flex gap-8 mb-10 border-b border-white/5 overflow-x-auto whitespace-nowrap scrollbar-hide">
            <button onclick="showSection('projects')" id="tab-projects" class="tab-btn active font-bold text-sm tracking-wide" data-i18n="nav_projects">Projetos</button>
            <button onclick="showSection('new')" id="tab-new" class="tab-btn font-bold text-sm tracking-wide" data-i18n="nav_new">+ Nova Obra</button>
            <button onclick="showSection('reports')" id="tab-reports" class="tab-btn font-bold text-sm tracking-wide" data-i18n="nav_reports">Relat√≥rios</button>
            <button onclick="showSection('logs')" id="tab-logs" class="tab-btn font-bold text-sm tracking-wide hidden admin-only" data-i18n="nav_logs">Auditoria</button>
            <button onclick="showSection('users')" id="tab-users" class="tab-btn font-bold text-sm tracking-wide hidden admin-only" data-i18n="nav_users">Usu√°rios</button>
        </div>

        <!-- Section: Active Projects -->
        <section id="section-projects" class="space-y-6">
            <h3 class="text-2xl font-bold tracking-tight mb-8" data-i18n="active_projects">Obras em Andamento</h3>
            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Projects injected here -->
            </div>
        </section>

        <!-- Section: New/Edit Form -->
        <section id="section-new" class="hidden max-w-3xl mx-auto">
            <div class="glass p-8">
                <h3 class="text-xl font-bold mb-8 text-amber-500" id="form-title" data-i18n="form_new">Novo Cadastro de Obra</h3>
                <form id="main-form" onsubmit="handleFormSubmit(event)" class="space-y-6">
                    <input type="hidden" id="edit-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest block mb-2 ml-1" data-i18n="field_client">Cliente</label>
                            <input type="text" name="cliente" required class="glass-input">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest block mb-2 ml-1" data-i18n="field_vendedor">Vendedor Respons√°vel</label>
                            <input type="text" name="vendedor" required class="glass-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest block mb-2 ml-1" data-i18n="field_value">Valor Total ($)</label>
                            <input type="number" step="0.01" name="valorTotal" required class="glass-input">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest block mb-2 ml-1" data-i18n="field_method">Forma de Pagamento</label>
                            <select name="metodo" class="glass-input">
                                <option value="Zelle">Zelle</option>
                                <option value="CC">Cart√£o de Cr√©dito (-3%)</option>
                                <option value="Cash">Cash</option>
                                <option value="Wire">Wire</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest block mb-2 ml-1" data-i18n="field_commission">% Comiss√£o</label>
                            <input type="number" name="percComissao" value="10" class="glass-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest block mb-2 ml-1" data-i18n="field_start">Data de In√≠cio</label>
                            <input type="date" name="dataInicio" required class="glass-input">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest block mb-2 ml-1" data-i18n="field_end">Previs√£o de Entrega</label>
                            <input type="date" name="dataEntrega" required class="glass-input">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest block mb-2 ml-1" data-i18n="field_status">Status de Execu√ß√£o</label>
                        <select name="status" class="glass-input">
                            <option value="Cota√ß√£o">Cota√ß√£o</option>
                            <option value="Aguardando In√≠cio">Aguardando In√≠cio</option>
                            <option value="Em Execu√ß√£o">Em Execu√ß√£o</option>
                            <option value="Finalizado">Finalizado</option>
                        </select>
                    </div>
                    <div class="flex gap-4 pt-8">
                        <button type="submit" class="flex-1 bg-amber-600 hover:bg-amber-500 p-4 btn-action text-white shadow-lg" data-i18n="btn_save">Confirmar e Salvar</button>
                        <button type="button" onclick="showSection('projects')" class="px-8 py-4 text-slate-400 font-bold hover:text-white transition-colors" data-i18n="btn_cancel">Cancelar</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Section: Reports -->
        <section id="section-reports" class="hidden">
            <div class="no-print glass p-8 mb-10">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest block mb-2 ml-1" data-i18n="field_company">Filtrar Empresa</label>
                        <select id="report-filter-company" class="glass-input">
                            <option value="All" data-i18n="all">Todas as Divis√µes</option>
                            <option value="Smart Home">D2 Smart Home</option>
                            <option value="HVAC">D2 HVAC Solutions</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold tracking-widest block mb-2 ml-1" data-i18n="field_status">Status</label>
                        <select id="report-filter-status" class="glass-input">
                            <option value="All" data-i18n="all">Todos os Status</option>
                            <option value="Em Execu√ß√£o" data-i18n="executing">Em Execu√ß√£o</option>
                            <option value="Finalizado" data-i18n="finished">Finalizado</option>
                        </select>
                    </div>
                    <button onclick="generateReport()" class="bg-amber-600 hover:bg-amber-500 p-3 btn-action text-white" data-i18n="btn_apply">Gerar Relat√≥rio</button>
                    <button onclick="window.print()" class="bg-slate-800 hover:bg-slate-700 p-3 btn-action text-white" data-i18n="btn_print">Imprimir / Salvar PDF</button>
                </div>
            </div>
            <div id="report-output"></div>
        </section>

        <!-- Section: Audit Logs -->
        <section id="section-logs" class="hidden">
            <div class="glass overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-white/5 text-slate-500 uppercase text-[10px] font-bold tracking-widest">
                        <tr>
                            <th class="p-5" data-i18n="log_date">Data/Hora</th>
                            <th class="p-5" data-i18n="log_user">Usu√°rio</th>
                            <th class="p-5" data-i18n="log_action">A√ß√£o</th>
                            <th class="p-5" data-i18n="log_details">Detalhes do Evento</th>
                        </tr>
                    </thead>
                    <tbody id="logs-body"></tbody>
                </table>
            </div>
        </section>

        <!-- Section: Users Management -->
        <section id="section-users" class="hidden">
            <div id="users-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </section>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDrLFiOuBwZblwKPuxBRK3R4fQpjQQbnDE",
        authDomain: "d2-project-management.firebaseapp.com",
        projectId: "d2-project-management",
        storageBucket: "d2-project-management.firebasestorage.app",
        messagingSenderId: "254630664761",
        appId: "1:254630664761:web:0d3c9c840bde488353cbe8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const appId = 'd2-Project-Management'; 
    const SUPER_ADMIN = "dante.frota@allcablingtech.com";

    let state = { currentUser: null, projects: [], lang: 'pt', company: 'Smart Home' };

    const translations = {
        pt: { 
            login_subtitle: "Fa√ßa login para gerenciar suas divis√µes", field_password: "Senha de Acesso", btn_login: "Entrar no Sistema", forgot_password: "Recuperar acesso?",
            nav_projects: "Projetos", nav_new: "+ Nova Obra", nav_reports: "Relat√≥rios", nav_logs: "Auditoria", nav_users: "Equipe",
            active_projects: "Obras em Andamento", field_client: "Cliente", field_vendedor: "Vendedor Respons√°vel", field_value: "Valor Total",
            field_method: "Forma de Pagamento", field_commission: "% Comiss√£o", field_start: "In√≠cio", field_end: "Entrega", field_status: "Status",
            btn_save: "Confirmar e Salvar", btn_cancel: "Cancelar", btn_print: "Imprimir / PDF", all: "Todas as Divis√µes", log_date: "Data/Hora",
            log_user: "Usu√°rio", log_action: "A√ß√£o", log_details: "Detalhes", field_company: "Empresa", btn_apply: "Gerar Relat√≥rio",
            executing: "Em Execu√ß√£o", finished: "Finalizado", form_new: "Novo Cadastro de Obra", form_edit: "Atualizar Cadastro"
        },
        en: {
            login_subtitle: "Login to manage your divisions", field_password: "Access Password", btn_login: "Sign In", forgot_password: "Reset password?",
            nav_projects: "Projects", nav_new: "+ New Project", nav_reports: "Reports", nav_logs: "Audit", nav_users: "Team",
            active_projects: "Ongoing Projects", field_client: "Client", field_vendedor: "Sales Rep", field_value: "Total Value",
            field_method: "Payment Method", field_commission: "% Comm.", field_start: "Start", field_end: "Delivery", field_status: "Status",
            btn_save: "Confirm & Save", btn_cancel: "Cancel", btn_print: "Print / PDF", all: "All Divisions", log_date: "Date/Time",
            log_user: "User", log_action: "Action", log_details: "Details", field_company: "Company", btn_apply: "Generate Report",
            executing: "In Progress", finished: "Finished", form_new: "New Project Registry", form_edit: "Update Registry"
        },
        es: {
            login_subtitle: "Inicie sesi√≥n para gestionar sus divisiones", field_password: "Contrase√±a de Acceso", btn_login: "Entrar al Sistema", forgot_password: "¬øOlvid√≥ su clave?",
            nav_projects: "Proyectos", nav_new: "+ Nueva Obra", nav_reports: "Informes", nav_logs: "Auditor√≠a", nav_users: "Equipo",
            active_projects: "Obras en Curso", field_client: "Cliente", field_vendedor: "Vendedor Responsable", field_value: "Valor Total",
            field_method: "Forma de Pago", field_commission: "% Comisi√≥n", field_start: "Inicio", field_end: "Entrega", field_status: "Estado",
            btn_save: "Confirmar y Guardar", btn_cancel: "Cancelar", btn_print: "Imprimir / PDF", all: "Todas as Divisiones", log_date: "Fecha/Hora",
            log_user: "Usuario", log_action: "Acci√≥n", log_details: "Detalles", field_company: "Empresa", btn_apply: "Generar Informe",
            executing: "En Ejecuci√≥n", finished: "Finalizado", form_new: "Nuevo Registro de Obra", form_edit: "Actualizar Registro"
        }
    };

    async function addLog(action, details) {
        if (!state.currentUser) return;
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                timestamp: serverTimestamp(),
                user: state.currentUser.email,
                action: action,
                details: details
            });
        } catch (e) { console.error("Log failed", e); }
    }

    window.handleAuth = async (e) => {
        e.preventDefault();
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value.trim();
        try {
            const cred = await signInWithEmailAndPassword(auth, email, password);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_credentials', cred.user.uid), {
                email, password, lastLogin: serverTimestamp()
            }, { merge: true });
        } catch (err) { alert("Acesso negado: " + err.message); }
    };

    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        state.currentUser = user;
        document.getElementById('auth-container').classList.toggle('hidden', !!user);
        document.getElementById('app-container').classList.toggle('hidden', !user);
        
        if (user) {
            document.getElementById('user-display').innerText = user.email;
            if (user.email === SUPER_ADMIN) {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            }

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), snap => {
                state.projects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderProjects();
                if (user.email === SUPER_ADMIN) renderUserManagement();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), snap => {
                renderLogs(snap.docs.map(d => d.data()));
            });
        }
    });

    window.handleFormSubmit = async (e) => {
        e.preventDefault();
        const f = new FormData(e.target);
        const editId = document.getElementById('edit-id').value;
        const data = {
            empresa: state.company,
            cliente: f.get('cliente'),
            vendedor: f.get('vendedor'),
            valorTotal: parseFloat(f.get('valorTotal')),
            metodo: f.get('metodo'),
            percComissao: parseInt(f.get('percComissao')),
            dataInicio: f.get('dataInicio'),
            dataEntrega: f.get('dataEntrega'),
            status: f.get('status'),
            updatedAt: serverTimestamp()
        };

        try {
            if (editId) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', editId), data);
                await addLog('EDIT', `Obra: ${data.cliente}`);
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), {
                    ...data, createdAt: serverTimestamp()
                });
                await addLog('NEW', `Obra: ${data.cliente}`);
            }
            e.target.reset();
            showSection('projects');
        } catch (err) { alert(err.message); }
    };

    window.deleteProject = async (id, name) => {
        if (!confirm(`Excluir a obra de ${name}?`)) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', id));
            await addLog('DELETE', `Obra: ${name}`);
        } catch (err) { alert(err.message); }
    };

    window.editProject = (id) => {
        const p = state.projects.find(x => x.id === id);
        if (!p) return;
        document.getElementById('edit-id').value = id;
        document.getElementById('form-title').setAttribute('data-i18n', 'form_edit');
        setLanguage(state.lang);
        const f = document.getElementById('main-form');
        f.cliente.value = p.cliente;
        f.vendedor.value = p.vendedor;
        f.valorTotal.value = p.valorTotal;
        f.metodo.value = p.metodo;
        f.percComissao.value = p.percComissao;
        f.dataInicio.value = p.dataInicio;
        f.dataEntrega.value = p.dataEntrega;
        f.status.value = p.status;
        showSection('new');
    };

    function renderProjects() {
        const grid = document.getElementById('projects-grid');
        grid.innerHTML = '';
        state.projects.filter(p => p.empresa === state.company).forEach(p => {
            let base = p.valorTotal * (p.metodo === 'CC' ? 0.97 : 1);
            const comm = (base * (p.percComissao / 100)).toFixed(2);
            const card = document.createElement('div');
            card.className = 'glass p-6 space-y-5 border-l-4 transition-transform hover:scale-[1.02] ' + (p.status === 'Finalizado' ? 'border-emerald-500' : 'border-amber-500');
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-bold text-lg text-white">${p.cliente}</h4>
                        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">${p.vendedor} ‚Ä¢ ${p.metodo}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editProject('${p.id}')" class="p-2 hover:bg-white/10 rounded-lg text-slate-400 hover:text-white transition-colors">‚úèÔ∏è</button>
                        <button onclick="deleteProject('${p.id}', '${p.cliente}')" class="p-2 hover:bg-red-500/10 rounded-lg text-slate-400 hover:text-red-400 transition-colors">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm bg-black/40 p-4 rounded-xl border border-white/5">
                    <div>
                        <p class="text-[9px] text-slate-500 font-bold uppercase mb-1">Total Obra</p>
                        <p class="font-bold text-white">$ ${p.valorTotal.toLocaleString()}</p>
                    </div>
                    <div>
                        <p class="text-[9px] text-slate-500 font-bold uppercase mb-1">Comiss√£o Liq.</p>
                        <p class="text-amber-500 font-bold">$ ${comm}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center text-[11px] font-medium">
                    <span class="px-2 py-1 rounded-md bg-white/5 text-slate-300 uppercase tracking-tighter">${p.status}</span>
                    <span class="text-slate-500">${new Date(p.dataEntrega).toLocaleDateString()}</span>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    async function renderUserManagement() {
        const container = document.getElementById('users-list');
        container.innerHTML = '';
        const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'user_credentials'));
        snap.forEach(d => {
            const u = d.data();
            const el = document.createElement('div');
            el.className = 'glass p-6 flex justify-between items-center';
            el.innerHTML = `
                <div>
                    <p class="font-bold text-white mb-1">${u.email}</p>
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] text-slate-500 font-bold uppercase">Password:</span>
                        <input type="password" value="${u.password}" id="p-view-${d.id}" readonly class="pass-list-input">
                        <button onclick="togglePasswordVisibility('p-view-${d.id}')" class="text-xs text-slate-500 hover:text-amber-400">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="text-[10px] text-slate-600 text-right">
                    D2 Equipe
                </div>
            `;
            container.appendChild(el);
        });
    }

    function renderLogs(logs) {
        const body = document.getElementById('logs-body');
        body.innerHTML = '';
        const sorted = [...logs].sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        sorted.slice(0, 30).forEach(l => {
            body.innerHTML += `
                <tr class="log-row border-b border-white/5 hover:bg-white/[0.02] transition-colors">
                    <td class="p-5 text-[11px] text-slate-500">${l.timestamp?.toDate().toLocaleString() || '...'}</td>
                    <td class="p-5 text-xs font-bold text-slate-300">${l.user}</td>
                    <td class="p-5 text-[10px] font-black text-amber-500 uppercase tracking-widest">${l.action}</td>
                    <td class="p-5 text-xs text-slate-400">${l.details}</td>
                </tr>
            `;
        });
    }

    window.generateReport = () => {
        const out = document.getElementById('report-output');
        const cF = document.getElementById('report-filter-company').value;
        const sF = document.getElementById('report-filter-status').value;
        const filtered = state.projects.filter(p => (cF === 'All' || p.empresa === cF) && (sF === 'All' || p.status === sF));
        
        const logoUrl = cF === 'HVAC' ? 'logo-D2-HVAC-Solutions-preto.png' : 
                      (cF === 'Smart Home' ? 'logo-D2-SmartHome-preto.png' : 'logo-D2-Group-preto.png');

        let totalV = 0, totalC = 0;
        const rows = filtered.map(p => {
            let com = p.valorTotal * (p.metodo === 'CC' ? 0.97 : 1) * (p.percComissao / 100);
            totalV += p.valorTotal; totalC += com;
            return `<tr class="border-b border-gray-100"><td class="py-3 text-xs font-bold">${p.cliente}</td><td class="text-xs text-gray-600">${p.vendedor}</td><td class="text-right text-xs">$ ${p.valorTotal.toFixed(2)}</td><td class="text-right text-xs font-bold text-amber-600">$ ${com.toFixed(2)}</td></tr>`;
        }).join('');
        
        out.innerHTML = `
            <div class="p-10 bg-white text-slate-900 rounded-3xl shadow-2xl report-card">
                <div class="flex justify-between items-start border-b-2 border-slate-100 pb-8 mb-8">
                    <img src="${logoUrl}" alt="D2 Logo" style="max-height: 70px;">
                    <div class="text-right">
                        <h2 class="text-xl font-black uppercase tracking-tighter text-slate-800">Relat√≥rio de Gest√£o</h2>
                        <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mt-1">Gerado em: ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
                <table class="w-full text-sm mb-10">
                    <thead><tr class="text-left bg-slate-50 text-slate-500 text-[10px] font-black uppercase"><th class="p-3">Cliente</th><th class="p-3">Vendedor</th><th class="p-3 text-right">Faturamento</th><th class="p-3 text-right">Comiss√£o Liq.</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="flex justify-end gap-12 pt-8 border-t-2 border-slate-100">
                    <div class="text-right">
                        <p class="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-1">Faturamento Total</p>
                        <p class="text-3xl font-black text-slate-900">$ ${totalV.toLocaleString(undefined, {minimumFractionDigits: 2})}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-amber-500 uppercase font-black tracking-widest mb-1">Comiss√µes Totais</p>
                        <p class="text-3xl font-black text-amber-600">$ ${totalC.toLocaleString(undefined, {minimumFractionDigits: 2})}</p>
                    </div>
                </div>
            </div>`;
    };

    window.setLanguage = (lang) => {
        state.lang = lang;
        document.querySelectorAll('.flag-btn').forEach(b => b.classList.toggle('active', b.id === 'lang-'+lang));
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang][key]) el.innerText = translations[lang][key];
        });
    };

    window.switchCompany = (c) => {
        state.company = c;
        const logoEl = document.getElementById('header-logo');
        const btnS = document.getElementById('btn-smart');
        const btnH = document.getElementById('btn-hvac');
        
        if(c === 'Smart Home') {
            logoEl.src = 'logo-D2-SmartHome-preto.png';
            btnS.classList.add('bg-amber-600', 'text-white');
            btnS.classList.remove('text-slate-400');
            btnH.classList.remove('bg-amber-600', 'text-white');
            btnH.classList.add('text-slate-400');
        } else {
            logoEl.src = 'logo-D2-HVAC-Solutions-preto.png';
            btnH.classList.add('bg-amber-600', 'text-white');
            btnH.classList.remove('text-slate-400');
            btnS.classList.remove('bg-amber-600', 'text-white');
            btnS.classList.add('text-slate-400');
        }
        renderProjects();
    };

    window.showSection = (id) => {
        document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
        document.getElementById(`section-${id}`).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab-'+id));
    };

    window.togglePasswordVisibility = (id) => {
        const el = document.getElementById(id);
        if(el) el.type = el.type === 'password' ? 'text' : 'password';
    };

    setLanguage('pt');
</script>
</body>
</html>